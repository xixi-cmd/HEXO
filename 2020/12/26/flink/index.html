<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="content-language" content="zh-CN"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><title>F-link | å¾®å®¢</title><link rel="icon" href="https://cn.chen-shang.top/img/favicon.png"><meta name="keywords" content="JAVA,Flink"><meta name="description" content="Apache Flink æ˜¯ä¸€ä¸ªåœ¨æ— ç•Œå’Œæœ‰ç•Œæ•°æ®æµä¸Šè¿›è¡ŒçŠ¶æ€è®¡ç®—çš„æ¡†æ¶å’Œåˆ†å¸ƒå¼å¤„ç†å¼•æ“.Flink å·²ç»å¯ä»¥åœ¨æ‰€æœ‰å¸¸è§çš„é›†ç¾¤ç¯å¢ƒä¸­è¿è¡Œ,å¹¶ä»¥ in-memory çš„é€Ÿåº¦å’Œä»»æ„çš„è§„æ¨¡è¿›è¡Œè®¡ç®—.
å¯ä»¥ç±»æ¯”"><meta property="site_name" content="å¾®å®¢"><meta property="og:type" content="website"><meta property="og:url" content="http://example.com/2020/12/26/flink/"><meta property="og:title" content="F-link | å¾®å®¢"><meta property="og:site_name" content="å¾®å®¢"><meta property="og:description" content="Apache Flink æ˜¯ä¸€ä¸ªåœ¨æ— ç•Œå’Œæœ‰ç•Œæ•°æ®æµä¸Šè¿›è¡ŒçŠ¶æ€è®¡ç®—çš„æ¡†æ¶å’Œåˆ†å¸ƒå¼å¤„ç†å¼•æ“.Flink å·²ç»å¯ä»¥åœ¨æ‰€æœ‰å¸¸è§çš„é›†ç¾¤ç¯å¢ƒä¸­è¿è¡Œ,å¹¶ä»¥ in-memory çš„é€Ÿåº¦å’Œä»»æ„çš„è§„æ¨¡è¿›è¡Œè®¡ç®—.
å¯ä»¥ç±»æ¯”"><meta property="og:locale" content="zh-CN"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="F-link | å¾®å®¢"><meta name="twitter:description" content="Apache Flink æ˜¯ä¸€ä¸ªåœ¨æ— ç•Œå’Œæœ‰ç•Œæ•°æ®æµä¸Šè¿›è¡ŒçŠ¶æ€è®¡ç®—çš„æ¡†æ¶å’Œåˆ†å¸ƒå¼å¤„ç†å¼•æ“.Flink å·²ç»å¯ä»¥åœ¨æ‰€æœ‰å¸¸è§çš„é›†ç¾¤ç¯å¢ƒä¸­è¿è¡Œ,å¹¶ä»¥ in-memory çš„é€Ÿåº¦å’Œä»»æ„çš„è§„æ¨¡è¿›è¡Œè®¡ç®—.
å¯ä»¥ç±»æ¯”"><link rel="dns-prefetch" href="http://example.com/2020/12/26/flink/"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/StaticFile_HEXO@latest/butterfly/css/font-awesome-animation.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/StaticFile_HEXO@latest/butterfly/css/macWhite.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/xixi-cmd/JSD-/iconfont.css"><meta name="generator" content="Hexo 5.3.0"></head><body id="body"><div id="mask"></div><script type="text/javascript">$.getScript("/js/search.js",function(){searchFunc("/search.xml","local-search-input","local-search-result")})</script><div class="search-dialog" id="local-search"><div id="local-search-title">Local Search</div><input id="local-search-input" placeholder="Search the article" type="text"><hr><div id="local-search-result"><div id="local-hits"></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?8e216044fbe6b71b6fefc197c2508ed1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div style="display:flex"><div id="body-wrap"><nav class="site_nav" id="site_nav"><i id="openNav" class="fas fa-bars"></i> <i class="fas fa-search search-btn"></i><div id="mobileNav"><div class="author-info"><div><a href="/"><img src="https://thirdqq.qlogo.cn/g?b=sdk&amp;nk=3225454747&amp;s=140" alt="WeiKe_Joe" class="avatar"><div class="author">WeiKe_Joe</div></a></div><hr></div><ul><li><a href="/">èµ·å§‹é¡µğŸ¡</a></li><li><a href="/archives">å½’æ¡£ğŸ“•</a></li><li><a href="/tags">æ ‡ç­¾ğŸ—¿</a></li><li><a href="/categories">åˆ†ç±»ğŸ–¤</a></li><li><a href="/atom.xml">rssğŸ”—</a></li><li><a href="/link">å‹æƒ…é“¾æ¥ğŸ¤</a></li><li><a target="_blank" rel="noopener" href="https://user.qzone.qq.com/3225454747/main">QQç©ºé—´ğŸ§</a></li><li><a target="_blank" rel="noopener" href="https://travellings.now.sh">å¼€å¾€ğŸš€</a></li><li><a href="/liuyanban">ç•™è¨€æ¿ğŸ“¡</a></li></ul></div><ul><li><a href="/">èµ·å§‹é¡µğŸ¡</a></li><li><a href="/archives">å½’æ¡£ğŸ“•</a></li><li><a href="/tags">æ ‡ç­¾ğŸ—¿</a></li><li><a href="/categories">åˆ†ç±»ğŸ–¤</a></li><li><a href="/atom.xml">rssğŸ”—</a></li><li><a href="/link">å‹æƒ…é“¾æ¥ğŸ¤</a></li><li><a target="_blank" rel="noopener" href="https://user.qzone.qq.com/3225454747/main">QQç©ºé—´ğŸ§</a></li><li><a target="_blank" rel="noopener" href="https://travellings.now.sh">å¼€å¾€ğŸš€</a></li><li><a href="/liuyanban">ç•™è¨€æ¿ğŸ“¡</a></li></ul></nav><header><div class="card-content"><div class="author-info"><div><a href="/"><img src="https://thirdqq.qlogo.cn/g?b=sdk&amp;nk=3225454747&amp;s=140" alt="WeiKe_Joe" class="avatar"><div class="author">WeiKe_Joe</div></a></div></div><div id="description" class="description"><p>åœ¨äº’è”ç½‘è§’è½é‡ŒæŒ£æ‰çš„åšå®¢</p><div class="social-icon"><a target="_blank" rel="noopener" href="https://github.com/xixi-cmd"><i class="fab fa-github"></i></a> <a href="mailto:3225454747@qq.com"><i class="fas fa-envelope"></i></a> <a target="_blank" rel="noopener" href="https://space.bilibili.com/580303442"><i class="fab iconfont icon-bilibili-fill"></i></a> <a target="_blank" rel="noopener" href="https://music.163.com/#/user/home?id=3267730015"><i class="fab iconfont icon-wangyiyunyinyuemusic1193417easyiconnet"></i></a> <a target="_blank" rel="noopener" href="https://gusit.gitee.io/"><i class="fab iconfont icon-gitee-fill-round"></i></a> <a target="_blank" rel="noopener" href="https://www.cnblogs.com/UserZuoChen/"><i class="fab iconfont icon-bokeyuan"></i></a> <a target="_blank" rel="noopener" href="https://www.jianshu.com/u/ae6d65633faa"><i class="fab iconfont icon-jianshu"></i></a> <a target="_blank" rel="noopener" href="https://twitter.com/shelby86443093"><i class="fab fa-twitter"></i></a></div></div></div></header><main class="content"><article class="post"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><div class="post-title"><h2 class="title">F-link</h2></div><div class="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i> <span class="post-meta-label">Created 2020-12-26 | </span><i class="fas fa-history fa-fw post-meta-icon"></i> <span class="post-meta-label">Updated 2021-02-04</span></span></div><div class="meta-secondline"><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i> <span class="post-meta-label">Word Count:</span> <span class="word-count">7.9k | </span><i class="far fa-clock fa-fw post-meta-icon"></i> <span class="post-meta-label">Reading time:</span> <span>34min | </span><i class="far fa-eye fa-fw post-meta-icon"></i> <span id="/2020/12/26/flink/" class="leancloud_visitors"><span class="post-meta-label">Visitors:</span> <span class="leancloud-visitors-count" id="twikoo_visitors">0</span></span></span></div></div><div class="post-content"><p><strong>Apache Flink</strong> æ˜¯ä¸€ä¸ªåœ¨æ— ç•Œå’Œæœ‰ç•Œæ•°æ®æµä¸Šè¿›è¡ŒçŠ¶æ€è®¡ç®—çš„æ¡†æ¶å’Œåˆ†å¸ƒå¼å¤„ç†å¼•æ“.Flink å·²ç»å¯ä»¥åœ¨æ‰€æœ‰å¸¸è§çš„é›†ç¾¤ç¯å¢ƒä¸­è¿è¡Œ,å¹¶ä»¥ in-memory çš„é€Ÿåº¦å’Œä»»æ„çš„è§„æ¨¡è¿›è¡Œè®¡ç®—.</p><p>å¯ä»¥ç±»æ¯” <strong>spring batch</strong> æˆ–è€…<strong>spark</strong>è¿›è¡Œå­¦ä¹ ,åŸºæœ¬æµç¨‹å°±æ˜¯<strong>source-&gt;computer/transformation-&gt;sink</strong></p><p>æœ¬æ–‡ç« çš„å¤§éƒ¨åˆ†æ–‡å­—éƒ½æ¥æºäºäº’è”ç½‘,æœ€åº•ä¸‹ä¼šé™„ä¸Šé“¾æ¥.</p><a id="more"></a><h3 id="QuickStart"><a href="#QuickStart" class="headerlink" title="QuickStart"></a>QuickStart</h3><h4 id="æ­å»ºæ‰§è¡Œç¯å¢ƒ"><a href="#æ­å»ºæ‰§è¡Œç¯å¢ƒ" class="headerlink" title="æ­å»ºæ‰§è¡Œç¯å¢ƒ"></a>æ­å»ºæ‰§è¡Œç¯å¢ƒ</h4><p>è¿™è¾¹é€šè¿‡ <strong>docker-compose</strong> æ„å»º,å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥ä¸‹è½½ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶ç‰ˆæœ¬äº†,<a target="_blank" rel="noopener" href="https://flink.apache.org/downloads.html">download</a></p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Yaml"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">jobmanager:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">flink</span></span><br><span class="line">    <span class="attr">expose:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6123&quot;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8081:8081&quot;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">jobmanager</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JOB_MANAGER_RPC_ADDRESS=jobmanager</span></span><br><span class="line">  <span class="attr">taskmanager:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">flink</span></span><br><span class="line">    <span class="attr">expose:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6121&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6122&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">jobmanager</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">taskmanager</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;jobmanager:jobmanager&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JOB_MANAGER_RPC_ADDRESS=jobmanager</span></span><br></pre></td></tr></table></figure></div><h4 id="åˆ›å»ºåº”ç”¨"><a href="#åˆ›å»ºåº”ç”¨" class="headerlink" title="åˆ›å»ºåº”ç”¨"></a>åˆ›å»ºåº”ç”¨</h4><p>è¿™é‡Œæ ¹æ®åˆ›å»ºä¸€ä¸ª<code>WordCount</code>åº”ç”¨</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Groovy"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter() <span class="comment">// this applies only to the Gradle &#x27;Shadow&#x27; plugin</span></span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">&#x27;com.github.jengelman.gradle.plugins:shadow:2.0.4&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&#x27;java&#x27;</span></span><br><span class="line">    id <span class="string">&#x27;application&#x27;</span></span><br><span class="line">    <span class="comment">// shadow plugin to produce fat JARs</span></span><br><span class="line">    id <span class="string">&#x27;com.github.johnrengelman.shadow&#x27;</span> version <span class="string">&#x27;2.0.4&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">configurations &#123;</span><br><span class="line">    flinkShadowJar <span class="comment">// dependencies which go into the shadowJar</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// always exclude these (also from transitive dependencies) since they are provided by Flink</span></span><br><span class="line">    flinkShadowJar.exclude <span class="attr">group:</span> <span class="string">&#x27;org.apache.flink&#x27;</span>, <span class="attr">module:</span> <span class="string">&#x27;force-shading&#x27;</span></span><br><span class="line">    flinkShadowJar.exclude <span class="attr">group:</span> <span class="string">&#x27;com.google.code.findbugs&#x27;</span>, <span class="attr">module:</span> <span class="string">&#x27;jsr305&#x27;</span></span><br><span class="line">    flinkShadowJar.exclude <span class="attr">group:</span> <span class="string">&#x27;org.slf4j&#x27;</span></span><br><span class="line">    flinkShadowJar.exclude <span class="attr">group:</span> <span class="string">&#x27;org.apache.logging.log4j&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ext &#123;</span><br><span class="line">    javaVersion = <span class="string">&#x27;1.8&#x27;</span></span><br><span class="line">    flinkVersion = <span class="string">&#x27;1.11.2&#x27;</span></span><br><span class="line">    scalaBinaryVersion = <span class="string">&#x27;2.12&#x27;</span></span><br><span class="line">    slf4jVersion = <span class="string">&#x27;1.7.15&#x27;</span></span><br><span class="line">    log4jVersion = <span class="string">&#x27;2.12.1&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile <span class="string">&quot;org.apache.flink:flink-streaming-java_$&#123;scalaBinaryVersion&#125;:$&#123;flinkVersion&#125;&quot;</span></span><br><span class="line">    compile <span class="string">&quot;org.apache.flink:flink-clients_$&#123;scalaBinaryVersion&#125;:$&#123;flinkVersion&#125;&quot;</span></span><br><span class="line">    compile <span class="string">&quot;org.apache.flink:flink-connector-kafka_$&#123;scalaBinaryVersion&#125;:$&#123;fflinkVersion&#125;&quot;</span></span><br><span class="line">    compile <span class="string">&#x27;org.slf4j:slf4j-simple:1.7.21&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// make compileOnly dependencies available for tests:</span></span><br><span class="line">sourceSets &#123;</span><br><span class="line">    main.compileClasspath += configurations.flinkShadowJar</span><br><span class="line">    main.runtimeClasspath += configurations.flinkShadowJar</span><br><span class="line"></span><br><span class="line">    test.compileClasspath += configurations.flinkShadowJar</span><br><span class="line">    test.runtimeClasspath += configurations.flinkShadowJar</span><br><span class="line"></span><br><span class="line">    javadoc.classpath += configurations.flinkShadowJar</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run.classpath = sourceSets.main.runtimeClasspath</span><br><span class="line"></span><br><span class="line">jar &#123;</span><br><span class="line">    manifest &#123;</span><br><span class="line">        attributes <span class="string">&#x27;Built-By&#x27;</span>: System.getProperty(<span class="string">&#x27;user.name&#x27;</span>),</span><br><span class="line">                <span class="string">&#x27;Build-Jdk&#x27;</span>: System.getProperty(<span class="string">&#x27;java.version&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shadowJar &#123;</span><br><span class="line">    configurations = [project.configurations.flinkShadowJar]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WordCount</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// è·å–æœ¬åœ°æ‰§è¡Œç¯å¢ƒ</span></span><br><span class="line">        <span class="keyword">final</span> StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        <span class="comment">// è®¾ç½®å¹¶è¡Œæ•°é‡</span></span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// è·å–æ•°æ®æµ</span></span><br><span class="line">        DataStream&lt;String&gt; stream = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">9999</span>);</span><br><span class="line">        <span class="comment">// è½¬æ¢ç®—å­å¤„ç†æ•°æ®æµå¹¶è¾“å‡ºç»“æœ</span></span><br><span class="line">        stream.flatMap(<span class="keyword">new</span> Tokenizer()).keyBy(r -&gt; r.f0).sum(<span class="number">1</span>).print();</span><br><span class="line">        <span class="comment">// æ‰§è¡Œ</span></span><br><span class="line">        env.execute(<span class="string">&quot;Flink Streaming Java API Skeleton&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Tokenizer</span> <span class="keyword">implements</span> <span class="title">FlatMapFunction</span>&lt;<span class="title">String</span>, <span class="title">Tuple2</span>&lt;<span class="title">String</span>, <span class="title">Integer</span>&gt;&gt; </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flatMap</span><span class="params">(String value, Collector&lt;Tuple2&lt;String, Integer&gt;&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            String[] stringList = value.split(<span class="string">&quot;\\s&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (String s : stringList) &#123;</span><br><span class="line">                <span class="comment">// ä½¿ç”¨out.collectæ–¹æ³•å‘ä¸‹æ¸¸å‘é€æ•°æ®</span></span><br><span class="line">                out.collect(<span class="keyword">new</span> Tuple2(s, <span class="number">1</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>å¦‚æœæ˜¯åœ¨<strong>IDEA</strong>æœ¬åœ°è¿è¡Œçš„è¯,è®°å¾—å¼•å…¥ä¾èµ–<code>flink-clients</code></p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Shell"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lk 9999</span><br></pre></td></tr></table></figure></div><p>å¦‚æœï¼Œå·²ç»æ­å»ºå¥½äº† <strong>Flink WebUI</strong> è¿è¡Œç¯å¢ƒ,ä¸Šä¼ æäº¤ç¼–è¯‘å¥½çš„jaråŒ… <strong>JobGraph</strong> å³å¯,æˆ–è€…é€šè¿‡å‘½ä»¤è¡Œè¿è¡Œ</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Shell"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flink run -c todo.lib.flink.WordCount WordCount.jar</span><br></pre></td></tr></table></figure></div><h3 id="DataStream-API"><a href="#DataStream-API" class="headerlink" title="DataStream API"></a>DataStream API</h3><h4 id="DataSource"><a href="#DataSource" class="headerlink" title="DataSource"></a>DataSource</h4><h5 id="å†…ç½®æ•°æ®æº"><a href="#å†…ç½®æ•°æ®æº" class="headerlink" title="å†…ç½®æ•°æ®æº"></a>å†…ç½®æ•°æ®æº</h5><h6 id="Elements"><a href="#Elements" class="headerlink" title="Elements"></a>Elements</h6><p>ä»æ•°ç»„æˆ–è€…é›†åˆï¼Œä¸€èˆ¬æœ¬åœ°è°ƒè¯•ä½¿ç”¨</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String[] elementInput = <span class="keyword">new</span> String[]&#123;<span class="string">&quot;hello Flink&quot;</span>, <span class="string">&quot;Second Line&quot;</span>&#125;;</span><br><span class="line">DataStream&lt;String&gt; stream = env.fromElements(elementInput);</span><br></pre></td></tr></table></figure></div><h6 id="File"><a href="#File" class="headerlink" title="File"></a>File</h6><p>å¯ä»¥ä½¿ç”¨ <code>readTextFile</code> æ–¹æ³•ç›´æ¥è¯»å–æ–‡æœ¬æ–‡ä»¶, è¿™ç§æ–¹å¼å¯ä»¥ç”¨æ¥ç›‘æ§ä¸€ä¸‹ <strong>log</strong> æ—¥å¿—æ–‡ä»¶, ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>readFile</code> æ–¹æ³•é€šè¿‡æŒ‡å®š <code>InputFormat</code> æ¥è¯»å–ç‰¹å®šæ•°æ®ç±»å‹çš„æ–‡ä»¶, <code>InputFormat</code>å¯ä»¥æ˜¯å†…ç½®ç±»,å¦‚ <code>CsvInputFormat</code> æˆ–è€…ç”¨æˆ·è‡ªå®šä¹‰ <code>InputFormat</code> æ¥å£ç±».</p><p>åœ¨ <code>readFile()</code> æ–¹æ³•ä¸­æœ‰ä¸€é¡¹å‚æ•°ä¸º <code>WatchType</code>, å…±æœ‰ä¸¤ç§æ¨¡å¼ (<code>PROCESS_CONTINUOUSLY</code>/ <code>PROCESS_ONCE</code>). åœ¨ <code>PROCESS_CONTINUOUSLY</code> æ¨¡å¼ä¸‹, æ£€æµ‹åˆ°æ–‡ä»¶å˜åŠ¨å°±ä¼šå°†æ–‡ä»¶å…¨éƒ¨å†…å®¹åŠ è½½åœ¨ <strong>flink</strong>, åœ¨ <code>PROCESS_ONCE</code> æ¨¡å¼ä¸‹, åªä¼šå°†æ–‡ä»¶å˜åŠ¨çš„é‚£éƒ¨åˆ†åŠ è½½åˆ° <strong>flink</strong>.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ·»åŠ æ–‡ä»¶æº</span></span><br><span class="line"><span class="comment">// ç›´æ¥è¯»å–æ–‡æœ¬æ–‡ä»¶</span></span><br><span class="line">DataStream&lt;String&gt; stream = env.readTextFile(logPath);</span><br><span class="line"><span class="comment">// è¯»å–csv</span></span><br><span class="line">CsvInputFormat csvInput = <span class="keyword">new</span> RowCsvInputFormat(</span><br><span class="line">    <span class="keyword">new</span> Path(csvPath),                                        <span class="comment">// æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">    <span class="keyword">new</span> TypeInformation[]&#123;Types.STRING, Types.STRING, Types.STRING&#125;,<span class="comment">// å­—æ®µç±»å‹</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span>,                                             <span class="comment">// è¡Œåˆ†éš”ç¬¦</span></span><br><span class="line">    <span class="string">&quot;,&quot;</span>);                                            <span class="comment">// å­—æ®µåˆ†éš”ç¬¦</span></span><br><span class="line">csvInput.setSkipFirstLineAsHeader(<span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// æŒ‡å®š CsvInputFormat, ç›‘æ§csvæ–‡ä»¶(ä¸¤ç§æ¨¡å¼), æ—¶é—´é—´éš”æ˜¯10ms</span></span><br><span class="line">DataStream&lt;Row&gt; stream = env.readFile(csvInput, csvPath, FileProcessingMode.PROCESS_CONTINUOUSLY, <span class="number">10</span>);</span><br></pre></td></tr></table></figure></div><h6 id="Socket"><a href="#Socket" class="headerlink" title="Socket"></a>Socket</h6><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ·»åŠ Socketä½œä¸ºæ•°æ®è¾“å…¥æº</span></span><br><span class="line"><span class="comment">// 4ä¸ªå‚æ•° -&gt; (hostname:Ipåœ°å€, port:ç«¯å£, delimiter:åˆ†éš”ç¬¦, maxRetry:æœ€å¤§é‡è¯•æ¬¡æ•°)</span></span><br><span class="line">DataStream&lt;String&gt; stream = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">9999</span>, <span class="string">&quot;\n&quot;</span>, <span class="number">4</span>);</span><br></pre></td></tr></table></figure></div><h5 id="å¤–éƒ¨æ•°æ®æº"><a href="#å¤–éƒ¨æ•°æ®æº" class="headerlink" title="å¤–éƒ¨æ•°æ®æº"></a>å¤–éƒ¨æ•°æ®æº</h5><p>å¤–éƒ¨æ•°æ®æºæ˜¯é‡å¤´æˆ, ä¸€èˆ¬æ¥è¯´é¡¹ç›®ä¸­å‡æ˜¯ä½¿ç”¨å¤–éƒ¨æ•°æ®æºä½œä¸ºæ•°æ®çš„æºå¤´.</p><h6 id="ç¬¬ä¸‰æ–¹æ•°æ®æº"><a href="#ç¬¬ä¸‰æ–¹æ•°æ®æº" class="headerlink" title="ç¬¬ä¸‰æ–¹æ•°æ®æº"></a>ç¬¬ä¸‰æ–¹æ•°æ®æº</h6><p>flink é€šè¿‡å®ç° <code>SourceFunction</code> å®šä¹‰äº†éå¸¸ä¸°å¯Œçš„ç¬¬ä¸‰æ–¹æ•°æ®è¿æ¥å™¨.å¯¹äºç¬¬ä¸‰æ–¹æ•°æ®æº, flinkçš„æ”¯æŒåˆ†ä¸ºä¸‰ç§,æœ‰<strong>åªè¯»å‹</strong>(Twitter Streaming API / Netty ), <strong>åªå†™å‹</strong>( Cassandra / Elasticsearch / hadoop FileSystem), æ”¯æŒ<strong>è¯»å†™</strong>(Kafka / Amazon Kinesis / RabbitMQ)</p><ul><li>Apache Kafka (Source / Sink)</li><li>Apache Cassandra (Sink)</li><li>Amazon Kinesis Streams (Source / Sink)</li><li>Elasticsearch (Sink)</li><li>Hadoop FileSystem (Sink)</li><li>RabbitMQ (Source / Sink)</li><li>Apache NiFI (Source / Sink)</li><li>Twitter Streaming API (Source)</li><li>Apache Bahir ä¸­çš„è¿æ¥å™¨:</li><li>Apache ActiveMQ (Source / Sink)</li><li>Apache Flume (Sink)</li><li>Redis (Sink)</li><li>Akka (Sink)</li><li>Netty (Source)</li></ul><p><strong>ä»¥Kafka ä¸ºä¾‹ åšæ¼”ç¤º</strong></p><p>æˆ‘è¿™è¾¹æ˜¯è¿œç¨‹æœåŠ¡å™¨ä¸Š<strong>docker-compose</strong>å¯åŠ¨<strong>kafka</strong>,ä¸»è¦æ³¨æ„ä¸‹é¢çš„<strong>EN_IP</strong>è¡¨ç¤ºå¤–ç½‘çš„IPåœ°å€</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Yaml"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸€ä¸ª kafkaèŠ‚ç‚¹ å°±æ˜¯ä¸€ä¸ª brokerã€‚ä¸€ä¸ªé›†ç¾¤ç”±å¤šä¸ª broker ç»„æˆã€‚ä¸€ä¸ª brokerå¯ä»¥å®¹çº³å¤šä¸ª topic</span></span><br><span class="line"><span class="attr">KAFKA_BROKER_ID:</span> <span class="number">0</span></span><br><span class="line"><span class="comment"># é…ç½®zookeeperç®¡ç†kafkaçš„è·¯å¾„</span></span><br><span class="line"><span class="attr">KAFKA_ZOOKEEPER_CONNECT:</span> <span class="string">zookeeper:2181</span> </span><br><span class="line"><span class="comment"># æŠŠkafkaçš„åœ°å€ç«¯å£æ³¨å†Œç»™zookeeperï¼Œè‹¥è¿œç¨‹è®¿é—®è¦æ”¹æˆå¤–ç½‘IP,åƒä¸‡æ³¨æ„æ˜¯å¤–ç½‘IP</span></span><br><span class="line"><span class="attr">KAFKA_ADVERTISED_LISTENERS:</span> <span class="string">PLAINTEXT://$&#123;EN_IP&#125;:9092</span> </span><br><span class="line"><span class="comment"># é…ç½®kafkaçš„ç›‘å¬ç«¯å£</span></span><br><span class="line"><span class="attr">KAFKA_LISTENERS:</span> <span class="string">PLAINTEXT://0.0.0.0:9092</span>  </span><br></pre></td></tr></table></figure></div><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">properties.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;EN_IP:9092&quot;</span>);</span><br><span class="line">properties.setProperty(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">DataStream&lt;String&gt; dataStream = env</span><br><span class="line">    .addSource(<span class="keyword">new</span> FlinkKafkaConsumer&lt;&gt;(<span class="string">&quot;topic&quot;</span>, <span class="keyword">new</span> SimpleStringSchema(), properties));</span><br><span class="line">dataStream.print();</span><br></pre></td></tr></table></figure></div><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Shell"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it kafka_container_id bash</span><br><span class="line">cd /opt/kafka/bin</span><br><span class="line">// ç”Ÿäº§æ•°æ®</span><br><span class="line">./kafka-console-producer.sh --broker-list EN_IP:9092 --topic flink-test</span><br><span class="line">// æ¶ˆè´¹æ•°æ®</span><br><span class="line">./kafka-console-consumer.sh --bootstrap-server EN_IP:9092 --topic flink-test --from-beginning</span><br></pre></td></tr></table></figure></div><h6 id="è‡ªå®šä¹‰æ•°æ®æº"><a href="#è‡ªå®šä¹‰æ•°æ®æº" class="headerlink" title="è‡ªå®šä¹‰æ•°æ®æº"></a>è‡ªå®šä¹‰æ•°æ®æº</h6><p>ç”¨æˆ·ä¹Ÿå¯ä»¥è‡ªå·±å®šä¹‰è¿æ¥å™¨, é€šè¿‡å®ç° <code>SourceFunction</code> å®šä¹‰å•ä¸ªçº¿ç¨‹çš„æ¥å…¥çš„æ•°æ®è¿æ¥å™¨, ä¹Ÿå¯ä»¥é€šè¿‡å®ç°<code>ParallelSourceFunction</code> æ¥å£æˆ–è€…ç»§æ‰¿ <code>RichParallelSourceFunction</code> ç±»å®šä¹‰å¹¶å‘æ•°æ®æºæ¥å…¥å™¨.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SourceFromMySQL</span> <span class="keyword">extends</span> <span class="title">RichSourceFunction</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">    PreparedStatement ps;</span><br><span class="line">    <span class="keyword">private</span> Connection connection;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(SourceContext&lt;User&gt; ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ResultSet resultSet = ps.executeQuery();</span><br><span class="line">        <span class="keyword">while</span> (resultSet.next()) &#123;</span><br><span class="line">            User user = <span class="keyword">new</span> User(</span><br><span class="line">                resultSet.getInt(<span class="string">&quot;id&quot;</span>),</span><br><span class="line">                resultSet.getString(<span class="string">&quot;name&quot;</span>).trim());</span><br><span class="line">            ctx.collect(user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ........</span><br></pre></td></tr></table></figure></div><h4 id="Transformation"><a href="#Transformation" class="headerlink" title="Transformation"></a>Transformation</h4><h5 id="åŸºæœ¬è½¬æ¢ç®—å­"><a href="#åŸºæœ¬è½¬æ¢ç®—å­" class="headerlink" title="åŸºæœ¬è½¬æ¢ç®—å­"></a>åŸºæœ¬è½¬æ¢ç®—å­</h5><p>åŸºæœ¬è½¬æ¢ç®—å­ä¼šé’ˆå¯¹æµä¸­çš„æ¯ä¸€ä¸ªå•ç‹¬çš„äº‹ä»¶åšå¤„ç†,ä¹Ÿå°±æ˜¯è¯´æ¯ä¸€ä¸ªè¾“å…¥æ•°æ®ä¼šäº§ç”Ÿä¸€ä¸ªè¾“å‡ºæ•°æ®.å•å€¼è½¬æ¢,æ•°æ®çš„åˆ†å‰²,æ•°æ®çš„è¿‡æ»¤,éƒ½æ˜¯åŸºæœ¬è½¬æ¢æ“ä½œçš„å…¸å‹ä¾‹å­.è¿™ä¸ªæœ‰ä¸ªæ¦‚å¿µå°±è¡Œ,å¯ä»¥è·³è¿‡.</p><h6 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h6><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;SensorReading&gt; filteredReadings = readings.filter(r -&gt; r.temperature &gt;= <span class="number">25</span>);</span><br></pre></td></tr></table></figure></div><h6 id="map"><a href="#map" class="headerlink" title="map"></a>map</h6><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;String&gt; sensorIds = filteredReadings.map(r -&gt; r.id);</span><br></pre></td></tr></table></figure></div><h6 id="flatMap"><a href="#flatMap" class="headerlink" title="flatMap"></a>flatMap</h6><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;String&gt; splitIds = sensorIds</span><br><span class="line">    .flatMap((FlatMapFunction&lt;String, String&gt;)</span><br><span class="line">             (id, out) -&gt; &#123; <span class="keyword">for</span> (String s: id.split(<span class="string">&quot;_&quot;</span>)) &#123; out.collect(s);&#125;&#125;)</span><br><span class="line">    <span class="comment">// provide result type because Java cannot infer return type of lambda function</span></span><br><span class="line">    <span class="comment">// æä¾›ç»“æœçš„ç±»å‹ï¼Œå› ä¸ºJavaæ— æ³•æ¨æ–­åŒ¿åå‡½æ•°çš„è¿”å›å€¼ç±»å‹</span></span><br><span class="line">    .returns(Types.STRING);</span><br></pre></td></tr></table></figure></div><h6 id="richFunction"><a href="#richFunction" class="headerlink" title="richFunction"></a>richFunction</h6><p>åœ¨å‡½æ•°å¤„ç†æ•°æ®ä¹‹å‰,éœ€è¦åšä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œ;æˆ–è€…éœ€è¦åœ¨å¤„ç†æ•°æ®æ—¶å¯ä»¥è·å¾—å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡çš„ä¸€äº›ä¿¡æ¯;ä»¥åŠåœ¨å¤„ç†å®Œæ•°æ®æ—¶åšä¸€äº›æ¸…ç†å·¥ä½œ</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFlatMap</span> <span class="keyword">extends</span> <span class="title">RichFlatMapFunction</span>&lt;<span class="title">Integer</span>, <span class="title">Tuple2</span>&lt;<span class="title">Integer</span>, <span class="title">Integer</span>&gt;&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> subTaskIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration configuration)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> subTaskIndex = getRuntimeContext.getIndexOfThisSubtask;</span><br><span class="line">    <span class="comment">// åšä¸€äº›åˆå§‹åŒ–å·¥ä½œ</span></span><br><span class="line">    <span class="comment">// ä¾‹å¦‚å»ºç«‹ä¸€ä¸ªå’ŒHDFSçš„è¿æ¥</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flatMap</span><span class="params">(Integer in, Collector&lt;Tuple2&lt;Integer, Integer&gt;&gt; out)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (in % <span class="number">2</span> == subTaskIndex) &#123;</span><br><span class="line">      out.collect((subTaskIndex, in));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ¸…ç†å·¥ä½œï¼Œæ–­å¼€å’ŒHDFSçš„è¿æ¥ã€‚</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h5 id="é”®æ§æµè½¬æ¢ç®—å­"><a href="#é”®æ§æµè½¬æ¢ç®—å­" class="headerlink" title="é”®æ§æµè½¬æ¢ç®—å­"></a>é”®æ§æµè½¬æ¢ç®—å­</h5><p>å¾ˆå¤šæµå¤„ç†ç¨‹åºçš„ä¸€ä¸ªåŸºæœ¬è¦æ±‚å°±æ˜¯è¦èƒ½å¯¹æ•°æ®è¿›è¡Œåˆ†ç»„,åˆ†ç»„åçš„æ•°æ®å…±äº«æŸä¸€ä¸ªç›¸åŒçš„å±æ€§.<strong>DataStream API</strong>æä¾›äº†ä¸€ä¸ªå«åš<code>KeyedStream</code>çš„æŠ½è±¡,æ­¤æŠ½è±¡ä¼šä»é€»è¾‘ä¸Šå¯¹DataStreamè¿›è¡Œåˆ†åŒº,åˆ†åŒºåçš„æ•°æ®æ‹¥æœ‰åŒæ ·çš„<code>Key</code>å€¼,åˆ†åŒºåçš„æµäº’ä¸ç›¸å…³.</p><h6 id="keyBy"><a href="#keyBy" class="headerlink" title="keyBy"></a>keyBy</h6><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KeyedStream&lt;SensorReading, String&gt; keyed = readings.keyBy(r -&gt; r.id);</span><br></pre></td></tr></table></figure></div><h6 id="fold"><a href="#fold" class="headerlink" title="fold"></a>fold</h6><p>é€šè¿‡å°†æœ€åä¸€ä¸ªæ–‡ä»¶å¤¹æµä¸å½“å‰è®°å½•ç»„åˆæ¥æ¨å‡º KeyedStream.å®ƒä¼šå‘å›æ•°æ®æµ.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">KeyedStream.fold(<span class="string">&quot;1&quot;</span>, <span class="keyword">new</span> FoldFunction&lt;Integer, String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">fold</span><span class="params">(String accumulator, Integer value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> accumulator + <span class="string">&quot;=&quot;</span> + value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></div><h6 id="aggregate"><a href="#aggregate" class="headerlink" title="aggregate"></a>aggregate</h6><p>æ»šåŠ¨èšåˆç®—å­ç”±<code>KeyedStream</code>è°ƒç”¨,å¹¶ç”Ÿæˆä¸€ä¸ªèšåˆä»¥åçš„DataStream.</p><p>æ»šåŠ¨èšåˆç®—å­åªèƒ½ç”¨åœ¨æ»šåŠ¨çª—å£,ä¸èƒ½ç”¨åœ¨æ»‘åŠ¨çª—å£.</p><p>æ»šåŠ¨èšåˆæ“ä½œä¼šå¯¹æ¯ä¸€ä¸ªkeyéƒ½ä¿å­˜ä¸€ä¸ªçŠ¶æ€ã€‚å› ä¸ºçŠ¶æ€ä»æ¥ä¸ä¼šè¢«æ¸…ç©ºï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä½¿ç”¨æ»šåŠ¨èšåˆç®—å­æ—¶åªèƒ½ä½¿ç”¨åœ¨å«æœ‰æœ‰é™ä¸ªkeyçš„æµä¸Šé¢ã€‚</p><p>å¸¸è§çš„æ»šåŠ¨èšåˆç®—å­: sum,min,max,minBy,maxBy</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Tuple3&lt;Integer, Integer, Integer&gt;&gt; resultStream = inputStream</span><br><span class="line">    .keyBy(<span class="number">0</span>) <span class="comment">// key on first field of the tuple</span></span><br><span class="line">    .sum(<span class="number">1</span>);   <span class="comment">// sum the second field of the tuple in place</span></span><br></pre></td></tr></table></figure></div><h6 id="window"><a href="#window" class="headerlink" title="window"></a>window</h6><p>å…è®¸æŒ‰æ—¶é—´æˆ–å…¶ä»–æ¡ä»¶å¯¹ç°æœ‰ KeyedStream è¿›è¡Œåˆ†ç»„.ä»¥ä¸‹æ˜¯ä»¥ 10 ç§’çš„æ—¶é—´çª—å£èšåˆ:</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">inputStream.keyBy(<span class="number">0</span>).window(Time.seconds(<span class="number">10</span>));</span><br><span class="line">inputStream.keyBy(<span class="number">0</span>).windowAll(Time.seconds(<span class="number">10</span>));</span><br></pre></td></tr></table></figure></div><h6 id="window-join"><a href="#window-join" class="headerlink" title="window join"></a>window join</h6><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€äº› key å°†åŒä¸€ä¸ª window çš„ä¸¤ä¸ªæ•°æ®æµ join èµ·æ¥.</p><p>ä»¥ä¸‹ç¤ºä¾‹æ˜¯åœ¨ 5 ç§’çš„çª—å£ä¸­è¿æ¥ä¸¤ä¸ªæµ,å…¶ä¸­ç¬¬ä¸€ä¸ªæµçš„ç¬¬ä¸€ä¸ªå±æ€§çš„è¿æ¥æ¡ä»¶ç­‰äºå¦ä¸€ä¸ªæµçš„ç¬¬äºŒä¸ªå±æ€§</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">inputStream.join(inputStream1)</span><br><span class="line">           .where(<span class="number">0</span>).equalTo(<span class="number">1</span>)</span><br><span class="line">           .window(Time.seconds(<span class="number">5</span>))     </span><br><span class="line">           .apply (<span class="keyword">new</span> JoinFunction () &#123;...&#125;);</span><br></pre></td></tr></table></figure></div><h6 id="split"><a href="#split" class="headerlink" title="split"></a>split</h6><p>æ­¤åŠŸèƒ½æ ¹æ®æ¡ä»¶å°†æµæ‹†åˆ†ä¸ºä¸¤ä¸ªæˆ–å¤šä¸ªæµ.å½“æ‚¨è·å¾—æ··åˆæµå¹¶ä¸”æ‚¨å¯èƒ½å¸Œæœ›å•ç‹¬å¤„ç†æ¯ä¸ªæ•°æ®æµæ—¶,å¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SplitStream&lt;Integer&gt; split = inputStream.split(<span class="keyword">new</span> OutputSelector&lt;Integer&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterable&lt;String&gt; <span class="title">select</span><span class="params">(Integer value)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; output = <span class="keyword">new</span> ArrayList&lt;String&gt;(); </span><br><span class="line">        <span class="keyword">if</span> (value % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            output.add(<span class="string">&quot;even&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            output.add(<span class="string">&quot;odd&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> output;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></div><h6 id="select"><a href="#select" class="headerlink" title="select"></a>select</h6><p>æ­¤åŠŸèƒ½å…è®¸æ‚¨ä»æ‹†åˆ†æµä¸­é€‰æ‹©ç‰¹å®šæµ</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SplitStream&lt;Integer&gt; split;</span><br><span class="line">DataStream&lt;Integer&gt; even = split.select(<span class="string">&quot;even&quot;</span>); </span><br><span class="line">DataStream&lt;Integer&gt; odd = split.select(<span class="string">&quot;odd&quot;</span>); </span><br><span class="line">DataStream&lt;Integer&gt; all = split.select(<span class="string">&quot;even&quot;</span>,<span class="string">&quot;odd&quot;</span>);</span><br></pre></td></tr></table></figure></div><h6 id="project"><a href="#project" class="headerlink" title="project"></a>project</h6><p>Project å‡½æ•°å…è®¸æ‚¨ä»äº‹ä»¶æµä¸­é€‰æ‹©å±æ€§å­é›†,å¹¶ä»…å°†æ‰€é€‰å…ƒç´ å‘é€åˆ°ä¸‹ä¸€ä¸ªå¤„ç†æµ.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Tuple4&lt;Integer, Double, String, String&gt;&gt; in = <span class="comment">// [...] </span></span><br><span class="line">DataStream&lt;Tuple2&lt;String, String&gt;&gt; out = in.project(<span class="number">3</span>,<span class="number">2</span>);</span><br></pre></td></tr></table></figure></div><h6 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a>reduce</h6><p>reduceå‡½æ•°å¯ä»¥é€šè¿‡å®ç°æ¥å£ReduceFunctionæ¥åˆ›å»ºä¸€ä¸ªç±».ReduceFunctionæ¥å£å®šä¹‰äº†<code>reduce()</code>æ–¹æ³•,æ­¤æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªè¾“å…¥äº‹ä»¶,è¾“å…¥ä¸€ä¸ªç›¸åŒç±»å‹çš„äº‹ä»¶.</p><p>reduceä½œä¸ºæ»šåŠ¨èšåˆçš„æ³›åŒ–å®ç°,åŒæ ·ä¹Ÿè¦é’ˆå¯¹æ¯ä¸€ä¸ªkeyä¿å­˜çŠ¶æ€.å› ä¸ºçŠ¶æ€ä»æ¥ä¸ä¼šæ¸…ç©º,æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†reduceç®—å­åº”ç”¨åœ¨ä¸€ä¸ªæœ‰é™keyçš„æµä¸Š.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;SensorReading&gt; maxTempPerSensor = keyed</span><br><span class="line">    .reduce((r1, r2) -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (r1.temperature &gt; r2.temperature) &#123;</span><br><span class="line">            <span class="keyword">return</span> r1;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> r2;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure></div><h5 id="å¤šæµè½¬æ¢ç®—å­"><a href="#å¤šæµè½¬æ¢ç®—å­" class="headerlink" title="å¤šæµè½¬æ¢ç®—å­"></a>å¤šæµè½¬æ¢ç®—å­</h5><p>è®¸å¤šåº”ç”¨éœ€è¦æ‘„å…¥å¤šä¸ªæµå¹¶å°†æµåˆå¹¶å¤„ç†,è¿˜å¯èƒ½éœ€è¦å°†ä¸€æ¡æµåˆ†å‰²æˆå¤šæ¡æµç„¶åé’ˆå¯¹æ¯ä¸€æ¡æµåº”ç”¨ä¸åŒçš„ä¸šåŠ¡é€»è¾‘.</p><h6 id="union"><a href="#union" class="headerlink" title="union"></a>union</h6><p>åˆæµçš„æ–¹å¼ä¸ºFIFOæ–¹å¼,åˆå¹¶æµç±»å‹è¦ä¸€è‡´.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;SensorReading&gt; parisStream = ...</span><br><span class="line">DataStream&lt;SensorReading&gt; tokyoStream = ...</span><br><span class="line">DataStream&lt;SensorReading&gt; rioStream = ...</span><br><span class="line">DataStream&lt;SensorReading&gt; allCities = parisStream</span><br><span class="line">  .union(tokyoStream, rioStream)</span><br></pre></td></tr></table></figure></div><h6 id="connect-comap-coflatmap"><a href="#connect-comap-coflatmap" class="headerlink" title="connect,comap,coflatmap"></a>connect,comap,coflatmap</h6><p>ä¸¤ä¸ªæµçš„æ•°æ®ç±»å‹å¯ä»¥ä¸åŒ,ä¼šå¯¹ä¸¤ä¸ªæµä¸­çš„æ•°æ®åº”ç”¨ä¸åŒçš„å¤„ç†æ–¹æ³•.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Tuple2&lt;Integer, Long&gt;&gt; one = ...</span><br><span class="line">DataStream&lt;Tuple2&lt;Integer, String&gt;&gt; two = ...</span><br><span class="line"><span class="comment">// keyBy two connected streams</span></span><br><span class="line">ConnectedStreams&lt;Tuple2&lt;Int, Long&gt;, Tuple2&lt;Integer, String&gt;&gt; keyedConnect1 = one</span><br><span class="line">  .connect(two)</span><br><span class="line">  .keyBy(<span class="number">0</span>, <span class="number">0</span>); <span class="comment">// key both input streams on first attribute</span></span><br><span class="line"><span class="comment">// alternative: connect two keyed streams</span></span><br><span class="line">ConnectedStreams&lt;Tuple2&lt;Integer, Long&gt;, Tuple2&lt;Integer, String&gt;&gt; keyedConnect2 = one</span><br><span class="line">  .keyBy(<span class="number">0</span>)</span><br><span class="line">  .connect(two.keyBy(<span class="number">0</span>));</span><br></pre></td></tr></table></figure></div><h5 id="åˆ†å¸ƒå¼è½¬æ¢ç®—å­"><a href="#åˆ†å¸ƒå¼è½¬æ¢ç®—å­" class="headerlink" title="åˆ†å¸ƒå¼è½¬æ¢ç®—å­"></a>åˆ†å¸ƒå¼è½¬æ¢ç®—å­</h5><p>å®šä¹‰äº†äº‹ä»¶å¦‚ä½•åˆ†é…åˆ°ä¸åŒçš„ä»»åŠ¡ä¸­å»</p><p>å½“æˆ‘ä»¬ä½¿ç”¨DataStream APIæ¥ç¼–å†™ç¨‹åºæ—¶,ç³»ç»Ÿå°†è‡ªåŠ¨çš„é€‰æ‹©æ•°æ®åˆ†åŒºç­–ç•¥,ç„¶åæ ¹æ®æ“ä½œç¬¦çš„è¯­ä¹‰å’Œè®¾ç½®çš„å¹¶è¡Œåº¦å°†æ•°æ®è·¯ç”±åˆ°æ­£ç¡®çš„åœ°æ–¹å».æœ‰äº›æ—¶å€™,æˆ‘ä»¬éœ€è¦åœ¨åº”ç”¨ç¨‹åºçš„å±‚é¢æ§åˆ¶åˆ†åŒºç­–ç•¥,æˆ–è€…è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥</p><h6 id="random"><a href="#random" class="headerlink" title="random"></a>random</h6><p>éšæœºæ•°æ®äº¤æ¢ç”±<code>DataStream.shuffle()</code>æ–¹æ³•å®ç°ã€‚shuffleæ–¹æ³•å°†æ•°æ®éšæœºçš„åˆ†é…åˆ°ä¸‹æ¸¸ç®—å­çš„å¹¶è¡Œä»»åŠ¡ä¸­å»</p><h6 id="round-robin"><a href="#round-robin" class="headerlink" title="round-robin"></a>round-robin</h6><p><code>rebalance()</code>æ–¹æ³•ä½¿ç”¨Round-Robinè´Ÿè½½å‡è¡¡ç®—æ³•å°†è¾“å…¥æµå¹³å‡åˆ†é…åˆ°éšåçš„å¹¶è¡Œè¿è¡Œçš„ä»»åŠ¡ä¸­å»</p><h6 id="rescale"><a href="#rescale" class="headerlink" title="rescale"></a>rescale</h6><p><code>rescale()</code>æ–¹æ³•ä½¿ç”¨çš„ä¹Ÿæ˜¯round-robinç®—æ³•,ä½†åªä¼šå°†æ•°æ®å‘é€åˆ°æ¥ä¸‹æ¥çš„å¹¶è¡Œè¿è¡Œçš„ä»»åŠ¡ä¸­çš„ä¸€éƒ¨åˆ†ä»»åŠ¡ä¸­.æœ¬è´¨ä¸Š,å½“å‘é€è€…ä»»åŠ¡æ•°é‡å’Œæ¥æ”¶è€…ä»»åŠ¡æ•°é‡ä¸ä¸€æ ·æ—¶,rescaleåˆ†åŒºç­–ç•¥æä¾›äº†ä¸€ç§è½»é‡çº§çš„è´Ÿè½½å‡è¡¡ç­–ç•¥.å¦‚æœæ¥æ”¶è€…ä»»åŠ¡çš„æ•°é‡æ˜¯å‘é€è€…ä»»åŠ¡çš„æ•°é‡çš„å€æ•°æ—¶,rescaleæ“ä½œå°†ä¼šæ•ˆç‡æ›´é«˜.</p><p><code>rebalance()</code>å’Œ<code>rescale()</code>çš„æ ¹æœ¬åŒºåˆ«åœ¨äºä»»åŠ¡ä¹‹é—´è¿æ¥çš„æœºåˆ¶ä¸åŒ.<code>rebalance()</code>å°†ä¼šé’ˆå¯¹æ‰€æœ‰å‘é€è€…ä»»åŠ¡å’Œæ‰€æœ‰æ¥æ”¶è€…ä»»åŠ¡ä¹‹é—´å»ºç«‹é€šä¿¡é€šé“,è€Œ<code>rescale()</code>ä»…ä»…é’ˆå¯¹æ¯ä¸€ä¸ªä»»åŠ¡å’Œä¸‹æ¸¸ç®—å­çš„ä¸€éƒ¨åˆ†å­å¹¶è¡Œä»»åŠ¡ä¹‹é—´å»ºç«‹é€šä¿¡é€šé“</p><h6 id="broadcast"><a href="#broadcast" class="headerlink" title="broadcast"></a>broadcast</h6><p><code>broadcast()</code>æ–¹æ³•å°†è¾“å…¥æµçš„æ‰€æœ‰æ•°æ®å¤åˆ¶å¹¶å‘é€åˆ°ä¸‹æ¸¸ç®—å­çš„æ‰€æœ‰å¹¶è¡Œä»»åŠ¡ä¸­å».</p><h6 id="global"><a href="#global" class="headerlink" title="global"></a>global</h6><p><code>global()</code>æ–¹æ³•å°†æ‰€æœ‰çš„è¾“å…¥æµæ•°æ®éƒ½å‘é€åˆ°ä¸‹æ¸¸ç®—å­çš„ç¬¬ä¸€ä¸ªå¹¶è¡Œä»»åŠ¡ä¸­å».è¿™ä¸ªæ“ä½œéœ€è¦å¾ˆè°¨æ…,å› ä¸ºå°†æ‰€æœ‰æ•°æ®å‘é€åˆ°åŒä¸€ä¸ªtask,å°†ä¼šå¯¹åº”ç”¨ç¨‹åºé€ æˆå¾ˆå¤§çš„å‹åŠ›.</p><h6 id="custom"><a href="#custom" class="headerlink" title="custom"></a>custom</h6><p>å½“Flinkæä¾›çš„åˆ†åŒºç­–ç•¥éƒ½ä¸é€‚ç”¨æ—¶,æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>partitionCustom()</code>æ–¹æ³•æ¥è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥.è¿™ä¸ªæ–¹æ³•æ¥æ”¶ä¸€ä¸ª<code>Partitioner</code>å¯¹è±¡,è¿™ä¸ªå¯¹è±¡éœ€è¦å®ç°åˆ†åŒºé€»è¾‘ä»¥åŠå®šä¹‰é’ˆå¯¹æµçš„å“ªä¸€ä¸ªå­—æ®µæˆ–è€…keyæ¥è¿›è¡Œåˆ†åŒº.</p><h4 id="Sink"><a href="#Sink" class="headerlink" title="Sink"></a>Sink</h4><p>Flinkæ²¡æœ‰ç±»ä¼¼äºsparkä¸­foreachæ–¹æ³•,è®©ç”¨æˆ·è¿›è¡Œè¿­ä»£çš„æ“ä½œ.æ‰€æœ‰å¯¹å¤–çš„è¾“å‡ºæ“ä½œéƒ½è¦åˆ©ç”¨Sinkå®Œæˆ.æœ€åé€šè¿‡ç±»ä¼¼å¦‚ä¸‹æ–¹å¼å®Œæˆæ•´ä¸ªä»»åŠ¡æœ€ç»ˆè¾“å‡ºæ“ä½œ.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stream.addSink(<span class="keyword">new</span> MySink(xxxx));</span><br></pre></td></tr></table></figure></div><p>å®˜æ–¹æä¾›äº†ä¸€éƒ¨åˆ†çš„æ¡†æ¶çš„sink.é™¤æ­¤ä»¥å¤–,éœ€è¦ç”¨æˆ·è‡ªå®šä¹‰å®ç°sink.</p><h5 id="ç¬¬ä¸‰æ–¹sink"><a href="#ç¬¬ä¸‰æ–¹sink" class="headerlink" title="ç¬¬ä¸‰æ–¹sink"></a>ç¬¬ä¸‰æ–¹sink</h5><h6 id="kafka"><a href="#kafka" class="headerlink" title="kafka"></a>kafka</h6><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Xml"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-kafka_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;String&gt; union = high</span><br><span class="line">  .union(low)</span><br><span class="line">  .map(r -&gt; r.temperature.toString);</span><br><span class="line"></span><br><span class="line">union.addSink(</span><br><span class="line">  <span class="keyword">new</span> FlinkKafkaProducer011&lt;String&gt;(</span><br><span class="line">    <span class="string">&quot;localhost:9092&quot;</span>,</span><br><span class="line">    <span class="string">&quot;test&quot;</span>,</span><br><span class="line">    <span class="keyword">new</span> SimpleStringSchema()</span><br><span class="line">  )</span><br><span class="line">);</span><br></pre></td></tr></table></figure></div><h6 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h6><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Xml"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.bahir<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-redis_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisSink_</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        DataStream&lt;User&gt; stream = env.addSource(<span class="keyword">new</span> UserSource());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        FlinkJedisPoolConfig conf = <span class="keyword">new</span> FlinkJedisPoolConfig.Builder().setHost(<span class="string">&quot;localhost&quot;</span>).build();</span><br><span class="line"></span><br><span class="line">        stream.addSink(<span class="keyword">new</span> RedisSink&lt;SensorReading&gt;(conf, <span class="keyword">new</span> MyRedisSink()));</span><br><span class="line"></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRedisSink</span> <span class="keyword">implements</span> <span class="title">RedisMapper</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getKeyFromData</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> user.getId().toString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getValueFromData</span><span class="params">(User User)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> user.getName();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> RedisCommandDescription <span class="title">getCommandDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> RedisCommandDescription(RedisCommand.HSET, <span class="string">&quot;flink-test&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Shell"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it redis_container_id redis-cli</span><br><span class="line">auth 123456</span><br><span class="line">keys keys flink-test</span><br><span class="line">hvals flink-test</span><br></pre></td></tr></table></figure></div><h6 id="elasticsearch"><a href="#elasticsearch" class="headerlink" title="elasticsearch"></a>elasticsearch</h6><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Xml"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-elasticsearch6_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- å¯é€‰ä¾èµ– --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EsSink_</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        DataStreamSource&lt;User&gt; stream = env.addSource(<span class="keyword">new</span> UserSource());</span><br><span class="line"></span><br><span class="line">        ArrayList&lt;HttpHost&gt; httpHosts = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        httpHosts.add(<span class="keyword">new</span> HttpHost(<span class="string">&quot;localhost&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>));</span><br><span class="line">        ElasticsearchSink.Builder&lt;User&gt; sensorReadingBuilder = <span class="keyword">new</span> ElasticsearchSink.Builder&lt;&gt;(</span><br><span class="line">                httpHosts,</span><br><span class="line">                (ElasticsearchSinkFunction&lt;User&gt;) (user, runtimeContext, requestIndexer) -&gt; &#123;</span><br><span class="line">                    HashMap&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">                    map.put(<span class="string">&quot;data&quot;</span>, user.toString());</span><br><span class="line">                    IndexRequest indexRequest = Requests</span><br><span class="line">                            .indexRequest()</span><br><span class="line">                            .index(<span class="string">&quot;flink-test&quot;</span>) <span class="comment">// ç´¢å¼•æ˜¯flink-testï¼Œç›¸å½“äºæ•°æ®åº“</span></span><br><span class="line">                            .type(<span class="string">&quot;user&quot;</span>) <span class="comment">// es6éœ€è¦åŠ è¿™ä¸€å¥</span></span><br><span class="line">                            .source(map);</span><br><span class="line"></span><br><span class="line">                    requestIndexer.add(indexRequest);</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line">        sensorReadingBuilder.setBulkFlushMaxActions(<span class="number">1</span>);</span><br><span class="line">        stream.addSink(sensorReadingBuilder.build());</span><br><span class="line"></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h5 id="è‡ªå®šä¹‰sink"><a href="#è‡ªå®šä¹‰sink" class="headerlink" title="è‡ªå®šä¹‰sink"></a>è‡ªå®šä¹‰sink</h5><p>ç»§æ‰¿ RichSinkFunction æŠ½è±¡ç±»,é‡å†™ invoke æ–¹æ³•</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyJDBCSink</span> <span class="keyword">extends</span> <span class="title">RichSinkFunction</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Connection conn;</span><br><span class="line">    <span class="keyword">private</span> PreparedStatement insertStmt;</span><br><span class="line">    <span class="keyword">private</span> PreparedStatement updateStmt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(User value, Context context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        updateStmt.setString(<span class="number">1</span>, value.getName());</span><br><span class="line">        updateStmt.setInt(<span class="number">2</span>, value.getId());</span><br><span class="line">        updateStmt.execute();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (updateStmt.getUpdateCount() == <span class="number">0</span>) &#123;</span><br><span class="line">            insertStmt.setInt(<span class="number">1</span>, value.getId());</span><br><span class="line">            insertStmt.setString(<span class="number">2</span>, value.getName());</span><br><span class="line">            insertStmt.execute();</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ....</span><br></pre></td></tr></table></figure></div><h4 id="Window"><a href="#Window" class="headerlink" title="Window"></a>Window</h4><h5 id="æ—¶é—´-time"><a href="#æ—¶é—´-time" class="headerlink" title="æ—¶é—´ time"></a>æ—¶é—´ time</h5><p>äº‹ä»¶æ—¶é—´ <strong>Event Time</strong>,å³äº‹ä»¶å®é™…å‘ç”Ÿçš„æ—¶é—´,å¯ä»¥å¤„ç†ä¹±åºäº‹ä»¶,ä¸€èˆ¬éƒ½ç”¨è¿™ä¸ª;<br>æ‘„å…¥æ—¶é—´ <strong>Ingestion Time</strong>,äº‹ä»¶è¿›å…¥æµå¤„ç†æ¡†æ¶çš„æ—¶é—´;<br>å¤„ç†æ—¶é—´ <strong>Processing Time</strong>,äº‹ä»¶è¢«å¤„ç†çš„æ—¶é—´,æ‰§è¡Œæ“ä½œç®—å­çš„æœ¬åœ°æ—¶é—´,ä¸æœºå™¨æ— å…³.ç»Ÿè®¡æŸäº›å»¶æ—¶éå¸¸é«˜çš„æ—¥å¿—.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"><span class="comment">//è®¾ç½®æ—¶é—´å±æ€§ä¸º EventTime</span></span><br><span class="line">env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span><br><span class="line"></span><br><span class="line">DataStream&lt;MyEvent&gt; stream = env.addSource(<span class="keyword">new</span> FlinkKafkaConsumer09&lt;MyEvent&gt;(topic, schema, props));</span><br><span class="line">stream</span><br><span class="line">    .keyBy( (event) -&gt; event.getUser() )</span><br><span class="line">    .timeWindow(Time.hours(<span class="number">1</span>))</span><br><span class="line">    .reduce( (a, b) -&gt; a.add(b) )</span><br><span class="line">    .addSink(...);</span><br></pre></td></tr></table></figure></div><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™ä¸ªæ–¹æ³•ä¸­çš„ while å¾ªç¯éƒ¨åˆ†ä¼šä» eventTimeTimersQueue ä¸­ä¾æ¬¡å–å‡ºè§¦å‘æ—¶é—´å°äºå‚æ•° time çš„æ‰€æœ‰å®šæ—¶å™¨ï¼Œè°ƒç”¨ triggerTarget.onEventTime() æ–¹æ³•è¿›è¡Œè§¦å‘ã€‚è¿™å°±æ˜¯ EventTime ä»æ³¨å†Œåˆ°è§¦å‘çš„æµç¨‹ã€‚</span></span><br><span class="line">InternalTimeServiceImpl.advanceWatermarkã€‚</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">advanceWatermark</span><span class="params">(<span class="keyword">long</span> time)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   currentWatermark = time;</span><br><span class="line">   InternalTimer&lt;K, N&gt; timer;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">while</span> ((timer = eventTimeTimersQueue.peek()) != <span class="keyword">null</span> &amp;&amp; timer.getTimestamp() &lt;= time) &#123;</span><br><span class="line">      eventTimeTimersQueue.poll();</span><br><span class="line">      keyContext.setCurrentKey(timer.getKey());</span><br><span class="line">      triggerTarget.onEventTime(timer);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h5 id="æ°´ä½çº¿-watermark"><a href="#æ°´ä½çº¿-watermark" class="headerlink" title="æ°´ä½çº¿ watermark"></a>æ°´ä½çº¿ watermark</h5><h6 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h6><p><strong>æ°´å°çš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³å®æ—¶è®¡ç®—ä¸­çš„æ•°æ®ä¹±åºé—®é¢˜ï¼Œå®ƒçš„æœ¬è´¨æ˜¯ DataStream ä¸­ä¸€ä¸ªå¸¦æœ‰æ—¶é—´æˆ³çš„å…ƒç´ </strong>ã€‚</p><p>å¦‚æœ Flink ç³»ç»Ÿä¸­å‡ºç°äº†ä¸€ä¸ª WaterMark T,é‚£ä¹ˆå°±æ„å‘³ç€ EventTime &lt; T çš„æ•°æ®éƒ½å·²ç»åˆ°è¾¾,çª—å£çš„ç»“æŸæ—¶é—´å’Œ T ç›¸åŒçš„é‚£ä¸ªçª—å£è¢«<strong>è§¦å‘</strong>è¿›è¡Œè®¡ç®—äº†.</p><p>ä¹Ÿå°±æ˜¯è¯´:æ°´å°æ˜¯ Flink åˆ¤æ–­è¿Ÿåˆ°æ•°æ®çš„æ ‡å‡†,åŒæ—¶ä¹Ÿæ˜¯çª—å£è§¦å‘çš„æ ‡è®°.</p><p>åœ¨ç¨‹åºå¹¶è¡Œåº¦å¤§äº 1 çš„æƒ…å†µä¸‹,ä¼šæœ‰å¤šä¸ªæµäº§ç”Ÿæ°´å°å’Œçª—å£,è¿™æ—¶å€™ Flink ä¼šé€‰å–æ—¶é—´æˆ³æœ€å°çš„æ°´å°.</p><h6 id="ä½¿ç”¨æ°´å°"><a href="#ä½¿ç”¨æ°´å°" class="headerlink" title="ä½¿ç”¨æ°´å°"></a>ä½¿ç”¨æ°´å°</h6><p><strong>a. åœ¨ Source Function ä¸­ ç›´æ¥æŒ‡å®š Timestamps å’Œ Watermark</strong></p><p>ç”¨æˆ·éœ€è¦å¤å†™ SourceFunction æ¥å£ä¸­ run( ) æ–¹æ³•å®ç°æ•°æ®é€»è¾‘, åŒæ—¶è°ƒç”¨ SourceContext çš„ collectWithTimestamp( ) æ–¹æ³•ç”Ÿæˆ event time æ—¶é—´æˆ³, è°ƒç”¨ emitWatermark( ) æ–¹æ³•ç”Ÿæˆ watermark.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;String&gt; text = env.addSource(<span class="keyword">new</span> SourceFunction&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(SourceContext&lt;String&gt; ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">for</span> (String s : elementInput) &#123;</span><br><span class="line">                    <span class="comment">// åˆ‡å‰²æ¯ä¸€æ¡æ•°æ®</span></span><br><span class="line">                    String[] inp = s.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                    Long timestamp = <span class="keyword">new</span> Long(inp[<span class="number">1</span>]);</span><br><span class="line">                    <span class="comment">// ç”Ÿæˆ event time æ—¶é—´æˆ³</span></span><br><span class="line">                    ctx.collectWithTimestamp(s, timestamp);</span><br><span class="line">                    <span class="comment">// è°ƒç”¨ emitWatermark() æ–¹æ³•ç”Ÿæˆ watermark, æœ€å¤§å»¶è¿Ÿè®¾å®šä¸º 2</span></span><br><span class="line">                    ctx.emitWatermark(<span class="keyword">new</span> Watermark(timestamp - <span class="number">2</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// è®¾å®šé»˜è®¤ watermark</span></span><br><span class="line">                ctx.emitWatermark(<span class="keyword">new</span> Watermark(Long.MAX_VALUE));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure></div><p><strong>b. é€šè¿‡ Flink è‡ªå¸¦çš„ Timestamp Assigner æŒ‡å®š Timestamp å’Œ ç”Ÿæˆ watermark</strong></p><p><strong>b.1 ä½¿ç”¨ Ascending Timestamp Assigner æŒ‡å®š Timestamps å’Œ Watermark</strong></p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Tuple2&lt;String, Long&gt;&gt; dataStream = env.fromCollection(collectionInput);</span><br><span class="line">       dataStream.assignTimestampsAndWatermarks(</span><br><span class="line">               (WatermarkStrategy&lt;Tuple2&lt;String, Long&gt;&gt;) context -&gt; <span class="keyword">new</span> WatermarkGenerator&lt;Tuple2&lt;String,Long&gt;&gt;()&#123;</span><br><span class="line">                   <span class="keyword">private</span> <span class="keyword">long</span> maxTimestamp;</span><br><span class="line">                   <span class="keyword">private</span> <span class="keyword">long</span> delay = <span class="number">3000</span>;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">                           Tuple2&lt;String,Long&gt; event,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">long</span> eventTimestamp,</span></span></span><br><span class="line"><span class="function"><span class="params">                           WatermarkOutput output)</span></span>&#123;</span><br><span class="line">                       maxTimestamp = Math.max(maxTimestamp, event.f1);</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPeriodicEmit</span><span class="params">(WatermarkOutput output)</span></span>&#123;</span><br><span class="line">                       output.emitWatermark(<span class="keyword">new</span> Watermark(maxTimestamp - delay));</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br></pre></td></tr></table></figure></div><p><strong>b.2 å†…ç½®æ°´å°ç”Ÿæˆç­–ç•¥</strong></p><p><strong>b.2.1 å›ºå®šå»¶è¿Ÿç”Ÿæˆæ°´å°</strong></p><p>é€šè¿‡é™æ€æ–¹æ³•<code>forBoundedOutOfOrderness</code>æä¾›,å…¥å‚æ¥æ”¶ä¸€ä¸ªDurationç±»å‹çš„æ—¶é—´é—´éš”ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¯ä»¥æ¥å—çš„æœ€å¤§çš„å»¶è¿Ÿæ—¶é—´.ä½¿ç”¨è¿™ç§å»¶è¿Ÿç­–ç•¥çš„æ—¶å€™éœ€è¦æˆ‘ä»¬å¯¹æ•°æ®çš„å»¶è¿Ÿæ—¶é—´æœ‰ä¸€ä¸ªå¤§æ¦‚çš„é¢„ä¼°åˆ¤æ–­ã€‚</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WatermarkStrategy.forBoundedOutOfOrderness(Duration maxOutOfOrderness)</span><br></pre></td></tr></table></figure></div><p>æˆ‘ä»¬å®ç°ä¸€ä¸ªå»¶è¿Ÿ3ç§’çš„å›ºå®šå»¶è¿Ÿæ°´å°ï¼Œå¯ä»¥è¿™æ ·åšï¼š</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DataStream dataStream = ...... ;</span><br><span class="line">dataStream.assignTimestampsAndWatermarks(WatermarkStrategy.forBoundedOutOfOrderness(Duration.ofSeconds(<span class="number">3</span>)));</span><br></pre></td></tr></table></figure></div><p>ä»–çš„åº•å±‚ä½¿ç”¨çš„WatermarkGeneratoræ¥å£çš„ä¸€ä¸ªå®ç°ç±»BoundedOutOfOrdernessWatermarksã€‚æˆ‘ä»¬çœ‹ä¸‹æºç ä¸­çš„è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œæ˜¯ä¸æ˜¯å’Œæˆ‘ä»¬ä¸Šé¢è‡ªå·±å†™çš„å¾ˆåƒ.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(T event, <span class="keyword">long</span> eventTimestamp, WatermarkOutput output)</span> </span>&#123;</span><br><span class="line"> maxTimestamp = Math.max(maxTimestamp, eventTimestamp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPeriodicEmit</span><span class="params">(WatermarkOutput output)</span> </span>&#123;</span><br><span class="line"> output.emitWatermark(<span class="keyword">new</span> Watermark(maxTimestamp - outOfOrdernessMillis - <span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><strong>b.2.2 å•è°ƒé€’å¢ç”Ÿæˆæ°´å°</strong></p><p>é€šè¿‡é™æ€æ–¹æ³•<code>forMonotonousTimestamps</code>æ¥æä¾›.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WatermarkStrategy.forMonotonousTimestamps()</span><br></pre></td></tr></table></figure></div><p>è¿™ä¸ªä¹Ÿå°±æ˜¯ç›¸å½“äºä¸Šè¿°çš„å»¶è¿Ÿç­–ç•¥å»æ‰äº†å»¶è¿Ÿæ—¶é—´ï¼Œä»¥eventä¸­çš„æ—¶é—´æˆ³å……å½“äº†æ°´å°ã€‚</p><p>åœ¨ç¨‹åºä¸­å¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DataStream dataStream = ...... ;</span><br><span class="line">dataStream.assignTimestampsAndWatermarks(WatermarkStrategy.forMonotonousTimestamps());</span><br></pre></td></tr></table></figure></div><p>å®ƒçš„åº•å±‚å®ç°æ˜¯AscendingTimestampsWatermarksï¼Œå…¶å®å®ƒå°±æ˜¯BoundedOutOfOrdernessWatermarksç±»çš„ä¸€ä¸ªå­ç±»ï¼Œæ²¡æœ‰äº†å»¶è¿Ÿæ—¶é—´ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å…·ä½“æºç çš„å®ç°.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Public</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AscendingTimestampsWatermarks</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">BoundedOutOfOrdernessWatermarks</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Creates a new watermark generator with for ascending timestamps.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">AscendingTimestampsWatermarks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">super</span>(Duration.ofMillis(<span class="number">0</span>));</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h6 id="eventæ—¶é—´çš„è·å–"><a href="#eventæ—¶é—´çš„è·å–" class="headerlink" title="eventæ—¶é—´çš„è·å–"></a>eventæ—¶é—´çš„è·å–</h6><p>ä¸Šè¿°æˆ‘ä»¬è®²äº†flinkè‡ªå¸¦çš„ä¸¤ç§æ°´å°ç”Ÿæˆç­–ç•¥ï¼Œä½†æ˜¯å¯¹äºæˆ‘ä»¬ä½¿ç”¨eventtimeè¯­ä¹‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬æƒ³ä»æˆ‘ä»¬çš„è‡ªå·±çš„æ•°æ®ä¸­æŠ½å–eventtimeï¼Œè¿™ä¸ªå°±éœ€è¦TimestampAssigneräº†.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Public</span></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TimestampAssigner</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    ............</span><br><span class="line">    </span><br><span class="line"> <span class="function"><span class="keyword">long</span> <span class="title">extractTimestamp</span><span class="params">(T element, <span class="keyword">long</span> recordTimestamp)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>ä½¿ç”¨çš„æ—¶å€™æˆ‘ä»¬ä¸»è¦å°±æ˜¯ä»æˆ‘ä»¬è‡ªå·±çš„å…ƒç´ elementä¸­æå–æˆ‘ä»¬æƒ³è¦çš„eventtimeã€‚</p><p>ä½¿ç”¨flinkè‡ªå¸¦çš„æ°´å°ç­–ç•¥å’ŒeventtimeæŠ½å–ç±»ï¼Œå¯ä»¥è¿™æ ·ç”¨ï¼š</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DataStream dataStream = ...... ;</span><br><span class="line">dataStream.assignTimestampsAndWatermarks(</span><br><span class="line">    WatermarkStrategy</span><br><span class="line">      .&lt;Tuple2&lt;String,Long&gt;&gt;forBoundedOutOfOrderness(Duration.ofSeconds(<span class="number">5</span>))</span><br><span class="line">      .withTimestampAssigner((event, timestamp)-&gt;event.f1));</span><br></pre></td></tr></table></figure></div><h6 id="å¤„ç†ç©ºé—²æ•°æ®æº"><a href="#å¤„ç†ç©ºé—²æ•°æ®æº" class="headerlink" title="å¤„ç†ç©ºé—²æ•°æ®æº"></a>å¤„ç†ç©ºé—²æ•°æ®æº</h6><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç”±äºæ•°æ®äº§ç”Ÿçš„æ¯”è¾ƒå°‘ï¼Œå¯¼è‡´ä¸€æ®µæ—¶é—´å†…æ²¡æœ‰æ•°æ®äº§ç”Ÿï¼Œè¿›è€Œå°±æ²¡æœ‰æ°´å°çš„ç”Ÿæˆï¼Œå¯¼è‡´ä¸‹æ¸¸ä¾èµ–æ°´å°çš„ä¸€äº›æ“ä½œå°±ä¼šå‡ºç°é—®é¢˜ï¼Œæ¯”å¦‚æŸä¸€ä¸ªç®—å­çš„ä¸Šæ¸¸æœ‰å¤šä¸ªç®—å­ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œæ°´å°æ˜¯å–å…¶ä¸Šæ¸¸ä¸¤ä¸ªç®—å­çš„è¾ƒå°å€¼ï¼Œå¦‚æœä¸Šæ¸¸æŸä¸€ä¸ªç®—å­å› ä¸ºç¼ºå°‘æ•°æ®è¿Ÿè¿Ÿæ²¡æœ‰ç”Ÿæˆæ°´å°ï¼Œå°±ä¼šå‡ºç°eventtimeå€¾æ–œé—®é¢˜ï¼Œå¯¼è‡´ä¸‹æ¸¸æ²¡æ³•è§¦å‘è®¡ç®—ã€‚</p><p>æ‰€ä»¥filnké€šè¿‡WatermarkStrategy.withIdleness()æ–¹æ³•å…è®¸ç”¨æˆ·åœ¨é…ç½®çš„æ—¶é—´å†…ï¼ˆå³è¶…æ—¶æ—¶é—´å†…ï¼‰æ²¡æœ‰è®°å½•åˆ°è¾¾æ—¶å°†ä¸€ä¸ªæµæ ‡è®°ä¸ºç©ºé—²ã€‚è¿™æ ·å°±æ„å‘³ç€ä¸‹æ¸¸çš„æ•°æ®ä¸éœ€è¦ç­‰å¾…æ°´å°çš„åˆ°æ¥ã€‚</p><p>å½“ä¸‹æ¬¡æœ‰æ°´å°ç”Ÿæˆå¹¶å‘å°„åˆ°ä¸‹æ¸¸çš„æ—¶å€™ï¼Œè¿™ä¸ªæ•°æ®æµé‡æ–°å˜æˆæ´»è·ƒçŠ¶æ€ã€‚</p><p>é€šè¿‡ä¸‹é¢çš„ä»£ç æ¥å®ç°å¯¹äºç©ºé—²æ•°æ®æµçš„å¤„ç†</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WatermarkStrategy</span><br><span class="line">        .&lt;Tuple2&lt;Long, String&gt;&gt;forBoundedOutOfOrderness(Duration.ofSeconds(<span class="number">20</span>))</span><br><span class="line">        .withIdleness(Duration.ofMinutes(<span class="number">1</span>));</span><br></pre></td></tr></table></figure></div><h5 id="çª—å£ç®€ä»‹-window"><a href="#çª—å£ç®€ä»‹-window" class="headerlink" title="çª—å£ç®€ä»‹ window"></a>çª—å£ç®€ä»‹ window</h5><p>çª—å£æ˜¯æµå¼è®¡ç®—ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªæ¦‚å¿µ, å¾ˆå¤šå¸¸è§çš„åŠŸèƒ½éƒ½æ˜¯é€šè¿‡å„ç§çª—å£å®ç°çš„, æ¯”å¦‚æ¯5åˆ†é’Ÿç»Ÿè®¡ä¸€ä¸‹åˆšå»1å°æ—¶çš„çƒ­åº¦. Flink DataStream API å°†çª—å£ç‹¬ç«‹æˆ Operator. æ¯ä¸ªçª—å£ç®—å­åŒ…å«äº†ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†:</p><p><strong>Windows Assigner</strong></p><p>æŒ‡å®šçª—å£çš„ç±»å‹, å®šä¹‰å¦‚ä½•å°†æ•°æ®æµåˆ†é…åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªçª—å£</p><p><strong>Windows Trigger</strong></p><p>æŒ‡å®šçª—å£è§¦å‘çš„æ—¶æœº, å®šä¹‰çª—å£æ»¡è¶³ä»€ä¹ˆæ ·çš„æ¡ä»¶è§¦å‘è®¡ç®—</p><p><strong>Evictor</strong></p><p>ç”¨æˆ·æ•°æ®å‰”é™¤</p><p><strong>Lateness</strong></p><p>æ ‡è®°æ˜¯å¦å¤„ç†è¿Ÿåˆ°çš„æ•°æ®, å½“è¿Ÿåˆ°æ•°æ®åˆ°è¾¾çª—å£ä¸­æ˜¯å¦è§¦å‘è®¡ç®—</p><p><strong>Output Tag</strong></p><p>æ ‡è®°è¾“å‡ºæ ‡ç­¾, ç„¶åå†é€šè¿‡ getSideOutput å°†çª—å£ä¸­çš„æ•°æ®æ ¹æ®æ ‡ç­¾è¾“å‡º</p><p><strong>Windows Function</strong></p><p>å®šä¹‰çª—å£ä¸Šçš„æ•°æ®å¤„ç†çš„é€»è¾‘, ä¾‹å¦‚å¯¹æ•°æ®è¿›è¡Œsum</p><h5 id="Window-Assigner"><a href="#Window-Assigner" class="headerlink" title="Window Assigner"></a>Window Assigner</h5><p>é¦–å…ˆæœ€éœ€è¦äº†è§£çš„å°±æ˜¯ windows Assigneräº†, æˆ‘ä»¬æƒ³è¦ä¸€ä¸ªä»€ä¹ˆæ ·çš„çª—å£åˆ’åˆ†, ä¸»è¦å°±æ˜¯é€šè¿‡ä»–æ¥å®ç°çš„.</p><p>æ ¹æ® flink ä¸Šæ¸¸çš„æ•°æ®é›†æ˜¯å¦ä¸º KeyedStream ç±»å‹ æ¥åšåˆ†åˆ«çš„å¤„ç†. å¦‚æœä½¿ç”¨äº†keyBy( ) åˆ™å¯¹åº”ä½¿ç”¨window( ) æ¥å¤„ç†, å¦åˆ™å¯ä»¥ä½¿ç”¨ windowAll( )æ¥ä½¿ç”¨</p><p>Flink å¯ä»¥æ”¯æŒä¸¤ç§ç±»å‹çš„çª—å£, åˆ†åˆ«æ˜¯åŸºäºæ—¶é—´çš„çª—å£å’ŒåŸºäºæ•°é‡çš„çª—å£.åŸºäºæ—¶é—´çš„æ„æ€å°±æ˜¯æŒ‰ç…§æ—¶é—´å»åˆ’åˆ†çª—å£,åŒç†,åŸºäºæ•°é‡çš„ä¹Ÿæ˜¯æ ¹æ®çª—å£ä¸­çš„æ•°é‡æ¥åšåˆ‡åˆ†çš„. å¯¹åº”çš„åˆ†åˆ«å°±æ˜¯ timeWindow() å’Œ countWindow() æ¥ä½¿ç”¨, ä¸‹é¢çš„ç¤ºä¾‹ä¸»è¦ä½¿ç”¨ timeWindow() æ¥æ¼”ç¤º.</p><p>å¯¹äºä¸åŒçš„ Window Assigner, è¿˜å¯ä»¥æŠŠçª—å£åˆ’åˆ†ä¸º4å¤§ç±», åˆ†åˆ«æ˜¯ æ»šåŠ¨çª—å£(Tumbling Windows) / æ»‘åŠ¨çª—å£(Sliding Window) / ä¼šè¯çª—å£(Session Window) å’Œ å…¨å±€çª—å£(Global Window).</p><h6 id="æ»šåŠ¨çª—å£-Tumbling-Windows"><a href="#æ»šåŠ¨çª—å£-Tumbling-Windows" class="headerlink" title="æ»šåŠ¨çª—å£ Tumbling Windows"></a>æ»šåŠ¨çª—å£ Tumbling Windows</h6><p>DataStream API æä¾›åŸºäº EventTime å’Œ ProcessingTime çš„ä¸¤ç§ç±»å‹çš„ Tumbling window.å¯¹åº”çš„ Assigner åˆ†åˆ«æ˜¯ TumblingEventTimeWindow å’Œ ProcessingEventTimeWindow . ä¸¾ä¾‹å¦‚ä¸‹,å®Œæ•´ä»£ç è§Github.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Code"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; ä½¿ç”¨ProcessTimeçš„æ»šåŠ¨æ—¶é—´çª—å£, é•¿åº¦ä¸º10s</span><br><span class="line">stream.keyBy(x -&gt; x.f1)</span><br><span class="line">    .window(TumblingProcessingTimeWindows.of(Time.seconds(10))).process(...)</span><br><span class="line">&#x2F;&#x2F; ä½¿ç”¨ProcessTimeçš„æ»šåŠ¨æ—¶é—´çª—å£, é•¿åº¦ä¸º10s</span><br><span class="line">stream.keyBy(x -&gt;x.f1).window(TumblingEventTimeWindows.of(Time.seconds(10))).process(...)</span><br></pre></td></tr></table></figure></div><p>ä½¿ç”¨ window(TumblingProcessingTimeWindows.of(Time.seconds(10))) çš„æ–¹æ³•æœ‰ç‚¹å•°å—¦, Flink è¿˜æä¾›äº†timeWindow( ) çš„ API æ¥ç®€åŒ–è¿™ä¸€è¡Œä»£ç .</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Code"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; ç›´æ¥ä½¿ç”¨ timeWindow API ä¾¿å¯å®ç°æ»šåŠ¨çª—å£çš„æ“ä½œ, å‚æ•°ä¾æ—§æ˜¯çª—å£çš„é•¿åº¦</span><br><span class="line">&#x2F;&#x2F; çª—å£ç±»å‹çš„æ—¶é—´ç”± time characteristic ç¡®å®š, å¦‚æœæŒ‡å®šä¸º event time,é‚£ä¹ˆçª—å£ä¹Ÿä¼šè‡ªåŠ¨ç”¨è¿™ä¸ªæ—¶é—´</span><br><span class="line">input.keyBy(x -&gt; x.f1).timeWindow(Time.seconds(10));</span><br></pre></td></tr></table></figure></div><h6 id="æ»‘åŠ¨çª—å£-Sliding-Window"><a href="#æ»‘åŠ¨çª—å£-Sliding-Window" class="headerlink" title="æ»‘åŠ¨çª—å£ Sliding Window"></a>æ»‘åŠ¨çª—å£ Sliding Window</h6><p>æ»‘åŠ¨çª—å£é¡¾åæ€ä¹‰å°±æ˜¯ä¸€ä¸ªåœ¨ä¸æ–­å¾€åæ»‘åŠ¨çš„çª—å£, æ¯”å¦‚è¯´ æ¯5åˆ†é’Ÿ ç»Ÿè®¡ä¸€ä¸ª æœ€è¿‘ä¸€å°æ—¶çš„æ—¶é—´, é‚£ä¹ˆå°±éœ€è¦ç”¨æ»‘åŠ¨çª—å£æ¥åšå¤„ç†. æ»‘åŠ¨çª—å£ä¸»è¦æ˜¯ä¾é  window size å’Œ slide time æ¥ç¡®å®š. ä¸æ»šåŠ¨çª—å£ç±»ä¼¼çš„, flink ä¹Ÿæä¾›äº†å¯¹åº”ä¸åŒæ—¶é—´çš„ Assigner API(SlidingEventTimeWindow / SlidingEventTimeWindow), è¯­æ³•åŸºæœ¬ç±»ä¼¼, åªæ˜¯ç”±åŸæœ¬çš„ä¸€ä¸ªå‚æ•°(çª—å£é•¿åº¦) å˜ä¸ºäº†ä¸¤ä¸ªå‚æ•°(çª—å£é•¿åº¦å’Œæ»‘åŠ¨æ—¶é—´), åŒæ ·çš„, ä¸ºäº†ç®€åŒ–ä»£ç , ä¾ç„¶å¯ä»¥ä½¿ç”¨timeWindow() æ¥ç®€åŒ–.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Code"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; ä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ çª—å£é•¿åº¦ å’Œ æ»‘åŠ¨æ—¶é—´, çª—å£æ—¶é—´ç±»å‹ä¾æ—§é€šè¿‡time characteristic ç¡®å®š</span><br><span class="line">input.keyBy(x -&gt; x.f1).timeWindow(Time.seconds(10), Time.seconds(1))</span><br></pre></td></tr></table></figure></div><h6 id="ä¼šè¯çª—å£-Session-Window"><a href="#ä¼šè¯çª—å£-Session-Window" class="headerlink" title="ä¼šè¯çª—å£ Session Window"></a>ä¼šè¯çª—å£ Session Window</h6><p>ä¼šè¯çª—å£ä¸»è¦æ˜¯å°†æŸæ®µæ—¶é—´å†…æ´»è·ƒåº¦è¾ƒé«˜çš„æ•°æ®èšåˆæˆä¸€ä¸ªçª—å£è®¡ç®—. è§¦å‘æ¡ä»¶æ˜¯ Session Gap. åœ¨è§„å®šçš„æ—¶é—´å†…æ²¡æœ‰æ•°æ®æ¥å…¥åˆ™è®¤ä¸ºè¿™ä¸ªçª—å£ç»“æŸ,ç„¶åè§¦å‘çª—å£è®¡ç®—. Session Gap é™¤äº†å›ºå®šé—´éš”çš„æ–¹å¼, ä¹Ÿå¯ä»¥åŠ¨æ€æŠ½å–.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Code"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; åˆ›å»º Session Window, é—´éš”ä¸º 3s</span><br><span class="line">        DataStream&lt;Tuple3&lt;String, Long, Integer&gt;&gt; aggregated &#x3D; source</span><br><span class="line">                .keyBy(0)</span><br><span class="line">                .window(EventTimeSessionWindows.withGap(Time.seconds(3L)))</span><br><span class="line">                .sum(2);</span><br></pre></td></tr></table></figure></div><h6 id="å…¨å±€çª—å£-Global-Window"><a href="#å…¨å±€çª—å£-Global-Window" class="headerlink" title="å…¨å±€çª—å£ Global Window"></a>å…¨å±€çª—å£ Global Window</h6><p>å…¨å±€çª—å£å°†æ‰€æœ‰keyçš„æ•°æ®åˆ†é…åˆ°å•ä¸ªçª—å£ä¸­è®¡ç®—ç»“æœ.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Code"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; åˆ›å»º GlobalWindow</span><br><span class="line">        input.keyBy(1)</span><br><span class="line">                .window(GlobalWindows.create())</span><br><span class="line">                .sum(1);</span><br></pre></td></tr></table></figure></div><h5 id="Window-Function"><a href="#Window-Function" class="headerlink" title="Window Function"></a>Window Function</h5><p>Window Assigner çš„ä½œç”¨æ˜¯åˆ’åˆ†çª—å£çš„, è€Œ Window Function å°±æ˜¯å¯¹çª—å£å†…çš„æ•°æ®åšå¤„ç†çš„ä¸€ä¸ªè¿‡ç¨‹</p><h6 id="ReduceFunction-å¢é‡"><a href="#ReduceFunction-å¢é‡" class="headerlink" title="ReduceFunction (å¢é‡)"></a>ReduceFunction (å¢é‡)</h6><p>å¯¹è¾“å…¥çš„ä¸¤ä¸ªç›¸åŒç±»å‹çš„å…ƒç´ æŒ‰ç…§æŒ‡å®šçš„è®¡ç®—æ–¹å¼è¿›è¡Œèšåˆ, é€šè¿‡å®ç° ReduceFunction æ¥å£å°±å¯ä»¥åœ¨reduce( ) å‡½æ•°å†…éƒ¨è¿›è¡Œèšåˆæ“ä½œäº†.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">input.keyBy(x -&gt; x.f1).timeWindow(Time.seconds(<span class="number">10</span>), Time.seconds(<span class="number">1</span>))</span><br><span class="line">	.reduce((t1,t2) -&gt; <span class="keyword">new</span> Tuple2&lt;&gt;(t1.f0 + t2.f0, t1.f1));</span><br></pre></td></tr></table></figure></div><h6 id="AggregateFunction-å¢é‡"><a href="#AggregateFunction-å¢é‡" class="headerlink" title="AggregateFunction (å¢é‡)"></a>AggregateFunction (å¢é‡)</h6><p>AggregateFunction ç›¸å¯¹äºReduceFunctionæ›´åŠ çµæ´»,ä½†æ˜¯å®ç°èµ·æ¥ä¹Ÿæ›´å¤æ‚, AggregateFunctionæœ‰ 4 ä¸ªéœ€è¦å¤å†™çš„æ–¹æ³•, å…¶ä¸­createAccumulator( ) å®šä¹‰ç´¯åŠ å™¨, add( ) å®šä¹‰æ•°æ®çš„æ·»åŠ é€»è¾‘, getResult( ) å®šä¹‰äº†æ ¹æ® accumulator è®¡ç®—ç»“æœçš„é€»è¾‘, merge()æ–¹æ³•å®šä¹‰åˆå¹¶ accumulator çš„é€»è¾‘.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">input.keyBy(x -&gt; x.f1)</span><br><span class="line">    .timeWindow(Time.seconds(<span class="number">10</span>), Time.seconds(<span class="number">1</span>))</span><br><span class="line">    <span class="comment">// è‡ªå®šä¹‰ä¸€ä¸ªAggregateFunciton, å°†ç›¸åŒæ ‡å· f1 çš„æ•°æ®çš„ f0å­—ç¬¦ä¸²å­—æ®µåˆå¹¶åœ¨ä¸€èµ·</span></span><br><span class="line">    <span class="comment">// (&quot;hello&quot;, 1L) + (&quot;world&quot;, 1L) = (&quot;hello world&quot;, 1L)</span></span><br><span class="line">    .aggregate(<span class="keyword">new</span> MyAggregateFunction());</span><br></pre></td></tr></table></figure></div><p>é€šè¿‡è‡ªå®šä¹‰çš„ MyAggregateFunction() æ¥å®ç° AggregateFunction æ¥å£</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAggregateFunction</span> <span class="keyword">implements</span> <span class="title">AggregateFunction</span>&lt;<span class="title">Tuple2</span>&lt;<span class="title">String</span>, <span class="title">Long</span>&gt;, <span class="title">String</span>, <span class="title">String</span>&gt;</span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">createAccumulator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        	<span class="comment">// åˆå§‹åŒ–ç´¯åŠ å™¨</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">add</span><span class="params">(Tuple2&lt;String, Long&gt; t, String s)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// è¾“å…¥æ•°æ®ä¸ç´¯åŠ å™¨çš„åˆå¹¶</span></span><br><span class="line">            <span class="keyword">return</span> s + <span class="string">&quot; &quot;</span> +t.f0;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getResult</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// å¾—åˆ°ç´¯åŠ å™¨çš„ç»“æœ</span></span><br><span class="line">            <span class="keyword">return</span> s.trim();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">merge</span><span class="params">(String s, String acc1)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// åˆå¹¶ç´¯åŠ å™¨</span></span><br><span class="line">            <span class="keyword">return</span> s + <span class="string">&quot; &quot;</span> + acc1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div><h6 id="FoldFunction-å¢é‡"><a href="#FoldFunction-å¢é‡" class="headerlink" title="FoldFunction (å¢é‡)"></a>FoldFunction (å¢é‡)</h6><p>FoldFunctionå®šä¹‰äº†å¦‚ä½•å°†çª—å£ä¸­çš„è¾“å…¥å…ƒç´ ä¸å¤–éƒ¨çš„å…ƒç´ åˆå¹¶çš„é€»è¾‘</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">input.keyBy(x -&gt; x.f1)</span><br><span class="line">.timeWindow(Time.seconds(<span class="number">10</span>), Time.seconds(<span class="number">1</span>)).fold(<span class="string">&quot;flink&quot;</span>, (acc, t) -&gt;t.f0 + acc);</span><br></pre></td></tr></table></figure></div><p>FoldFunctionåœ¨æ–°ç‰ˆæœ¬å·²ç»è¢«æ ‡è®°@Deprecatedäº†, å»ºè®®ä½¿ç”¨AggregateFunctionä»£æ›¿</p><h6 id="ProcessWindowFunction-å…¨é‡"><a href="#ProcessWindowFunction-å…¨é‡" class="headerlink" title="ProcessWindowFunction (å…¨é‡)"></a>ProcessWindowFunction (å…¨é‡)</h6><p>ProcessWindowFunction ç›¸è¾ƒäºå…¶ä»–çš„ Window Function, å¯ä»¥å®ç°ä¸€äº›æ›´å¤æ‚çš„è®¡ç®—, æ¯”å¦‚åŸºäºæ•´ä¸ªçª—å£åšæŸäº›æŒ‡æ ‡è®¡ç®— æˆ–è€…éœ€è¦æ“ä½œçª—å£ä¸­çš„çŠ¶æ€æ•°æ®å’Œçª—å£å…ƒæ•°æ®. Flink æä¾›äº† ProcessWindowFunction è¿™ä¸ªæŠ½è±¡ç±», ç»§æ‰¿æ­¤ç±»å°±å¯ä»¥å®ç°ProcessWindowFunction, å…¶ä¸­, å¿…é¡»è¦å®ç° process( ) æ–¹æ³•, è¿™æ˜¯å¤„ç†çª—å£æ•°æ®çš„ä¸»è¦æ–¹æ³•.è¿˜åœ¨ä¸€ä¸‹è·Ÿçª—å£æ•°æ®ç›¸å…³çš„æ–¹æ³•å¯ä»¥æœ‰é€‰æ‹©çš„å®ç°.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyProcessWindowFunction</span> <span class="keyword">extends</span> <span class="title">ProcessWindowFunction</span>&lt;<span class="title">Tuple3</span>&lt;<span class="title">String</span>, <span class="title">Long</span>, <span class="title">Long</span>&gt;, <span class="title">String</span>, <span class="title">Long</span>, <span class="title">TimeWindow</span>&gt; </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Long s, Context context, Iterable&lt;Tuple3&lt;String, Long, Long&gt;&gt; 		elements, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// ç»Ÿè®¡æ¯ä¸ªçª—å£å†…çš„æ‰€æœ‰æ•°æ®çš„ f0å­—æ®µåŠ èµ·æ¥å…±æœ‰å¤šå°‘ä¸ªå•è¯</span></span><br><span class="line">        <span class="comment">// ä¹Ÿå°±åšå•ä¸ªçª—å£çš„ wordcount</span></span><br><span class="line">        Long count = <span class="number">0L</span>;</span><br><span class="line">        <span class="keyword">for</span> (Tuple3&lt;String, Long, Long&gt; element : elements) &#123;</span><br><span class="line">            count += element.f0.split(<span class="string">&quot; &quot;</span>).length;</span><br><span class="line">        &#125;</span><br><span class="line">        out.collect(<span class="string">&quot;window: &quot;</span> + context.window() + <span class="string">&quot; word count: &quot;</span> + count);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h5 id="Window-Join"><a href="#Window-Join" class="headerlink" title="Window Join"></a>Window Join</h5><p>Flink ä¸­æ”¯æŒçª—å£ä¸Šçš„å¤šæµåˆå¹¶, éœ€è¦ä¿è¯çš„æ˜¯è¾“å…¥çš„ stream è¦æ„å»ºåœ¨ç›¸åŒçš„ Window ä¸Š, å¹¶ä½¿ç”¨ç›¸åŒç±»å‹çš„ Key ä½œä¸ºå…³è”æ¡ä»¶.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">inputStream1.join(inputStream2)</span><br><span class="line">			<span class="comment">// æŒ‡å®šinputStream1çš„å…³è”key</span></span><br><span class="line">			.where(<span class="number">0</span>)</span><br><span class="line">			<span class="comment">// æŒ‡å®šinputStream2çš„å…³è”key</span></span><br><span class="line">			.equalTo(<span class="number">1</span>)</span><br><span class="line">			<span class="comment">// æŒ‡å®š window Assigner</span></span><br><span class="line">			.window(TumblingEventTimeWindows.of(Time.seconds(<span class="number">10</span>)))</span><br><span class="line">			<span class="comment">// æŒ‡å®šçª—å£è®¡ç®—å‡½æ•°</span></span><br><span class="line">			.apply(&lt;JoinFunction&gt;)</span><br></pre></td></tr></table></figure></div><h5 id="å¤„ç†è¿Ÿåˆ°çš„å…ƒç´ "><a href="#å¤„ç†è¿Ÿåˆ°çš„å…ƒç´ " class="headerlink" title="å¤„ç†è¿Ÿåˆ°çš„å…ƒç´ "></a>å¤„ç†è¿Ÿåˆ°çš„å…ƒç´ </h5><p>è¿Ÿåˆ°çš„å…ƒç´ æ˜¯æŒ‡å½“è¿™ä¸ªå…ƒç´ æ¥åˆ°æ—¶,è¿™ä¸ªå…ƒç´ æ‰€å¯¹åº”çš„çª—å£å·²ç»è®¡ç®—å®Œæ¯•äº†(ä¹Ÿå°±æ˜¯è¯´æ°´ä½çº¿å·²ç»æ²¡è¿‡çª—å£ç»“æŸæ—¶é—´äº†).è¿™è¯´æ˜è¿Ÿåˆ°è¿™ä¸ªç‰¹æ€§åªé’ˆå¯¹äº‹ä»¶æ—¶é—´.</p><p>DataStream APIæä¾›äº†ä¸‰ç§ç­–ç•¥æ¥å¤„ç†è¿Ÿåˆ°å…ƒç´ </p><h6 id="ç›´æ¥æŠ›å¼ƒ"><a href="#ç›´æ¥æŠ›å¼ƒ" class="headerlink" title="ç›´æ¥æŠ›å¼ƒ"></a>ç›´æ¥æŠ›å¼ƒ</h6><p>æŠ›å¼ƒè¿Ÿåˆ°çš„å…ƒç´ æ˜¯event time window operatorçš„é»˜è®¤è¡Œä¸º.ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªè¿Ÿåˆ°çš„å…ƒç´ ä¸ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„çª—å£.</p><p>process functionå¯ä»¥é€šè¿‡æ¯”è¾ƒè¿Ÿåˆ°å…ƒç´ çš„æ—¶é—´æˆ³å’Œå½“å‰æ°´ä½çº¿çš„å¤§å°æ¥å¾ˆè½»æ˜“çš„è¿‡æ»¤æ‰è¿Ÿåˆ°å…ƒç´ .</p><h6 id="é‡å®šå‘"><a href="#é‡å®šå‘" class="headerlink" title="é‡å®šå‘"></a>é‡å®šå‘</h6><p>è¿Ÿåˆ°çš„å…ƒç´ ä¹Ÿå¯ä»¥ä½¿ç”¨ä¾§è¾“å‡º(side output)ç‰¹æ€§è¢«é‡å®šå‘åˆ°å¦å¤–çš„ä¸€æ¡æµä¸­å».è¿Ÿåˆ°å…ƒç´ æ‰€ç»„æˆçš„ä¾§è¾“å‡ºæµå¯ä»¥ç»§ç»­å¤„ç†æˆ–è€…sinkåˆ°æŒä¹…åŒ–è®¾æ–½ä¸­å».</p><h6 id="æ›´æ–°çª—å£è®¡ç®—ç»“æœ"><a href="#æ›´æ–°çª—å£è®¡ç®—ç»“æœ" class="headerlink" title="æ›´æ–°çª—å£è®¡ç®—ç»“æœ"></a>æ›´æ–°çª—å£è®¡ç®—ç»“æœ</h6><p>ç”±äºå­˜åœ¨è¿Ÿåˆ°çš„å…ƒç´ ,æ‰€ä»¥å·²ç»è®¡ç®—å‡ºçš„çª—å£ç»“æœæ˜¯ä¸å‡†ç¡®å’Œä¸å®Œå…¨çš„.æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿Ÿåˆ°å…ƒç´ æ›´æ–°å·²ç»è®¡ç®—å®Œçš„çª—å£ç»“æœ.</p><p>window operator APIæä¾›äº†æ–¹æ³•æ¥æ˜ç¡®å£°æ˜æˆ‘ä»¬è¦ç­‰å¾…è¿Ÿåˆ°å…ƒç´ .å½“ä½¿ç”¨event-time window,æˆ‘ä»¬å¯ä»¥æŒ‡å®šä¸€ä¸ªæ—¶é—´æ®µå«åš<code>allowed lateness</code>.window operatorå¦‚æœè®¾ç½®äº†<code>allowed lateness</code>,è¿™ä¸ªwindow operatoråœ¨æ°´ä½çº¿æ²¡è¿‡çª—å£ç»“æŸæ—¶é—´æ—¶ä¹Ÿå°†ä¸ä¼šåˆ é™¤çª—å£å’Œçª—å£ä¸­çš„çŠ¶æ€.çª—å£ä¼šåœ¨ä¸€æ®µæ—¶é—´å†…(allowed latenessè®¾ç½®çš„)ä¿ç•™æ‰€æœ‰çš„å…ƒç´ .</p><p>å½“è¿Ÿåˆ°å…ƒç´ åœ¨<code>allowed lateness</code>æ—¶é—´å†…åˆ°è¾¾æ—¶,è¿™ä¸ªè¿Ÿåˆ°å…ƒç´ ä¼šè¢«å®æ—¶å¤„ç†å¹¶å‘é€åˆ°è§¦å‘å™¨(trigger).å½“æ°´ä½çº¿æ²¡è¿‡äº†çª—å£ç»“æŸæ—¶é—´+allowed latenessæ—¶é—´æ—¶,çª—å£ä¼šè¢«åˆ é™¤,å¹¶ä¸”æ‰€æœ‰åæ¥çš„è¿Ÿåˆ°çš„å…ƒç´ éƒ½ä¼šè¢«ä¸¢å¼ƒ.</p><h4 id="State"><a href="#State" class="headerlink" title="State"></a>State</h4><p>å®˜æ–¹æ–‡æ¡£æœ‰è¯¦ç»†æè¿°,è¿™é‡Œä¸å¤šèµ˜è¿°.</p><p><a target="_blank" rel="noopener" href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/zh/dev/stream/state/state.html">https://ci.apache.org/projects/flink/flink-docs-release-1.11/zh/dev/stream/state/state.html</a></p><h4 id="Table"><a href="#Table" class="headerlink" title="Table"></a>Table</h4><p>Flinkæœ¬èº«æ˜¯æ‰¹æµç»Ÿä¸€çš„å¤„ç†æ¡†æ¶,æ‰€ä»¥Table APIå’ŒSQL,å°±æ˜¯æ‰¹æµç»Ÿä¸€çš„ä¸Šå±‚å¤„ç†API.ç›®å‰è¿˜åœ¨å®Œå–„ä¸­,æ‰€ä»¥åé¢å¾…å®Œå–„.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Groovy"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">compileOnly <span class="string">&quot;org.apache.flink:flink-table-api-java-bridge_$&#123;scalaBinaryVersion&#125;:$&#123;flinkVersion&#125;&quot;</span></span><br><span class="line"><span class="comment">// æœ¬åœ°è¿è¡Œï¼Œçº¿ä¸Šlibå·²ç»åŒ…å«ï¼Œä¸éœ€è¦å¼•å…¥</span></span><br><span class="line">compileOnly <span class="string">&quot;org.apache.flink:flink-table-planner-blink_$&#123;scalaBinaryVersion&#125;:$&#123;flinkVersion&#125;&quot;</span></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰å‡½æ•°ï¼Œçº¿ä¸Šlibå·²ç»åŒ…å«ï¼Œä¸éœ€è¦å¼•å…¥</span></span><br><span class="line">compileOnly <span class="string">&quot;org.apache.flink:flink-table-common:$&#123;flinkVersion&#125;&quot;</span></span><br></pre></td></tr></table></figure></div><p><strong>æœªå®Œå¾…ç»­â€¦..</strong></p><h3 id="ç›¸å…³é“¾æ¥"><a href="#ç›¸å…³é“¾æ¥" class="headerlink" title="ç›¸å…³é“¾æ¥"></a>ç›¸å…³é“¾æ¥</h3><p><a target="_blank" rel="noopener" href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/">apache flink</a></p><p><a target="_blank" rel="noopener" href="https://github.com/apache/flink">github flink</a></p><p><a target="_blank" rel="noopener" href="https://github.com/zhisheng17/flink-learning">github flink-learning</a></p><p><a target="_blank" rel="noopener" href="https://github.com/CheckChe0803/flink-simple-tutorial">github flink-simple-tutorial</a></p><p><a target="_blank" rel="noopener" href="https://confucianzuoyuan.github.io/flink-tutorial/">å°šç¡…è°·</a></p></div><div class="post-copyright"><div class="post-copyright-icon"><a></a></div><div class="post-copyright__author"><span class="post-copyright-meta">Authorship: </span><span class="post-copyright-info"><a href="mailto:3225454747@qq.com" one-link-mark="yes">WeiKe_Joe</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Article Links: </span><span class="post-copyright-info"><a href="http://example.com/2020/12/26/flink/" one-link-mark="yes">http://example.com/2020/12/26/flink/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright: </span><span class="post-copyright-info">All articles in this blog are used unless otherwise stated <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" one-link-mark="yes">CC BY-NC-SA 4.0</a> License Agreement. Reprint please indicate from <a href="http://example.com" target="_blank" one-link-mark="yes">å¾®å®¢</a> ï¼</span></div></div><div class="post-tag"><span><i class="fa fa-tag"></i> <a href="tags/JAVA/"><span>JAVA</span></a> <i class="fas fa-angle-right"></i> <a href="tags/Flink/"><span>Flink</span></a></span></div><div class="social-share"></div></article><style data-pjax>#body-wrap{margin:60px 0;margin-left:300px}@media screen and (max-width:1400px){#body-wrap{margin:60px 0;margin-left:150px}}@media screen and (max-width:1300px){#body-wrap{margin:60px 0;margin-left:60px}}@media screen and (max-width:1200px){#toc{margin:60px 10px 0}#body-wrap{margin:60px 0 0 2%}}@media screen and (max-width:1100px){.comment-head{padding:0 20px 0 20px}}@media screen and (max-width:1000px){#toc{display:none;height:250px;position:fixed;right:35px;bottom:30px;top:48%;z-index:1000;width:280px;background:rgba(255,255,255,.9);margin:0}.toc{max-height:180px!important}#body-wrap{margin:60px auto}.rightside-toc{display:inline-block!important}}@media screen and (max-width:800px){.comment-head{padding:0 20px 30px 20px}}@media screen and (max-width:600px){.social-share{text-align:center;float:none;margin:0}}</style><script>setInterval(function(){document.body.clientWidth<800&&$("img#up").remove()},0)</script><section id="rightside"><div id="rightside-item"><a class="rightside-toc" title="Catalog"><i class="fas fa-list-ul"></i> </a><a href="#Direct comments" title="Direct comments"><i class="fas fa-comments"></i> </a><a href="#body" title="Back To Top"><i class="fas fa-arrow-up"></i></a></div></section><div class="pagination"><a href="/2020/12/26/git/" class="page-pre"><i class="fas fa-arrow-alt-circle-left"></i> git </a><a href="/2020/12/26/docker/" class="page-next">docker <i class="fas fa-arrow-alt-circle-right"></i></a></div><hr><section id="rightside"><div id="rightside-item"><a href="#Direct comments" title="Direct comments"><i class="fas fa-comments"></i> </a><a href="#body" title="Back To Top"><i class="fas fa-arrow-up"></i></a></div></section><div class="comment-head" id="Direct comments"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>Comments</span></div><div id="tcomment"></div></div></main></div><div id="toc"><div id="toc-title"><h4>Catalog <span id="num">0%</span></h4><progress id="progress" value="0" max="100"></progress></div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#QuickStart"><span class="toc-text">QuickStart</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E6%89%A7%E8%A1%8C%E7%8E%AF%E5%A2%83"><span class="toc-text">æ­å»ºæ‰§è¡Œç¯å¢ƒ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%BA%94%E7%94%A8"><span class="toc-text">åˆ›å»ºåº”ç”¨</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DataStream-API"><span class="toc-text">DataStream API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DataSource"><span class="toc-text">DataSource</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-text">å†…ç½®æ•°æ®æº</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Elements"><span class="toc-text">Elements</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#File"><span class="toc-text">File</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Socket"><span class="toc-text">Socket</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%96%E9%83%A8%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-text">å¤–éƒ¨æ•°æ®æº</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%96%B9%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-text">ç¬¬ä¸‰æ–¹æ•°æ®æº</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-text">è‡ªå®šä¹‰æ•°æ®æº</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Transformation"><span class="toc-text">Transformation</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E8%BD%AC%E6%8D%A2%E7%AE%97%E5%AD%90"><span class="toc-text">åŸºæœ¬è½¬æ¢ç®—å­</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#filter"><span class="toc-text">filter</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#map"><span class="toc-text">map</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#flatMap"><span class="toc-text">flatMap</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#richFunction"><span class="toc-text">richFunction</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%94%AE%E6%8E%A7%E6%B5%81%E8%BD%AC%E6%8D%A2%E7%AE%97%E5%AD%90"><span class="toc-text">é”®æ§æµè½¬æ¢ç®—å­</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#keyBy"><span class="toc-text">keyBy</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#fold"><span class="toc-text">fold</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#aggregate"><span class="toc-text">aggregate</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#window"><span class="toc-text">window</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#window-join"><span class="toc-text">window join</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#split"><span class="toc-text">split</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#select"><span class="toc-text">select</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#project"><span class="toc-text">project</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#reduce"><span class="toc-text">reduce</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%9A%E6%B5%81%E8%BD%AC%E6%8D%A2%E7%AE%97%E5%AD%90"><span class="toc-text">å¤šæµè½¬æ¢ç®—å­</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#union"><span class="toc-text">union</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#connect-comap-coflatmap"><span class="toc-text">connect,comap,coflatmap</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E8%BD%AC%E6%8D%A2%E7%AE%97%E5%AD%90"><span class="toc-text">åˆ†å¸ƒå¼è½¬æ¢ç®—å­</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#random"><span class="toc-text">random</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#round-robin"><span class="toc-text">round-robin</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#rescale"><span class="toc-text">rescale</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#broadcast"><span class="toc-text">broadcast</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#global"><span class="toc-text">global</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#custom"><span class="toc-text">custom</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Sink"><span class="toc-text">Sink</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%96%B9sink"><span class="toc-text">ç¬¬ä¸‰æ–¹sink</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#kafka"><span class="toc-text">kafka</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#redis"><span class="toc-text">redis</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#elasticsearch"><span class="toc-text">elasticsearch</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89sink"><span class="toc-text">è‡ªå®šä¹‰sink</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Window"><span class="toc-text">Window</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%B6%E9%97%B4-time"><span class="toc-text">æ—¶é—´ time</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B0%B4%E4%BD%8D%E7%BA%BF-watermark"><span class="toc-text">æ°´ä½çº¿ watermark</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-text">æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%B0%B4%E5%8D%B0"><span class="toc-text">ä½¿ç”¨æ°´å°</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#event%E6%97%B6%E9%97%B4%E7%9A%84%E8%8E%B7%E5%8F%96"><span class="toc-text">eventæ—¶é—´çš„è·å–</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E7%A9%BA%E9%97%B2%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-text">å¤„ç†ç©ºé—²æ•°æ®æº</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AA%97%E5%8F%A3%E7%AE%80%E4%BB%8B-window"><span class="toc-text">çª—å£ç®€ä»‹ window</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Window-Assigner"><span class="toc-text">Window Assigner</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%BB%9A%E5%8A%A8%E7%AA%97%E5%8F%A3-Tumbling-Windows"><span class="toc-text">æ»šåŠ¨çª—å£ Tumbling Windows</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3-Sliding-Window"><span class="toc-text">æ»‘åŠ¨çª—å£ Sliding Window</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E7%AA%97%E5%8F%A3-Session-Window"><span class="toc-text">ä¼šè¯çª—å£ Session Window</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E7%AA%97%E5%8F%A3-Global-Window"><span class="toc-text">å…¨å±€çª—å£ Global Window</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Window-Function"><span class="toc-text">Window Function</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#ReduceFunction-%E5%A2%9E%E9%87%8F"><span class="toc-text">ReduceFunction (å¢é‡)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#AggregateFunction-%E5%A2%9E%E9%87%8F"><span class="toc-text">AggregateFunction (å¢é‡)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#FoldFunction-%E5%A2%9E%E9%87%8F"><span class="toc-text">FoldFunction (å¢é‡)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#ProcessWindowFunction-%E5%85%A8%E9%87%8F"><span class="toc-text">ProcessWindowFunction (å…¨é‡)</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Window-Join"><span class="toc-text">Window Join</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E8%BF%9F%E5%88%B0%E7%9A%84%E5%85%83%E7%B4%A0"><span class="toc-text">å¤„ç†è¿Ÿåˆ°çš„å…ƒç´ </span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E6%8A%9B%E5%BC%83"><span class="toc-text">ç›´æ¥æŠ›å¼ƒ</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-text">é‡å®šå‘</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E7%AA%97%E5%8F%A3%E8%AE%A1%E7%AE%97%E7%BB%93%E6%9E%9C"><span class="toc-text">æ›´æ–°çª—å£è®¡ç®—ç»“æœ</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#State"><span class="toc-text">State</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Table"><span class="toc-text">Table</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E9%93%BE%E6%8E%A5"><span class="toc-text">ç›¸å…³é“¾æ¥</span></a></li></ol></div></div><img id="up" src="https://cdn.jsdelivr.net/gh/lete114/CDN/Use/up.gif" alt="rightside.å›åˆ°é¡¶éƒ¨"><footer class="footer" id="footer"><div class="copyright">&copy; 2020 - 2021 <i class="fas fa-heartbeat"></i> WeiKe_Joe</div><div class="framework-info"><span>Framework </span><a href="https://hexo.io" target="_blank">Hexo</a> <span class="footer-separator">|</span> <span>Theme </span><a href="https://github.com/lete114/hexo-theme-MengD" target="_blank">MengD.(èŒå…¸)</a></div><div class="custom-text">æˆ‘ä¸€ç›´åœ¨åæ€ï¼Œå¦‚æœæœªæ¥å·²å®šï¼Œé‚£ä¹ˆå¥‹æ–—çš„æ„ä¹‰ä½•åœ¨ï¼›å¦‚æœæœªæ¥ä¸å®šã€‚é‚£ä¹ˆå½“ä¸‹è¯¥å¦‚ä½•è¡ŒåŠ¨ï¼Ÿ</div></footer><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script src="/js/main.js"></script><script src="/js/style.js"></script><script src="/live2d-widget/autoload.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="https://api.vvhan.com/api/snow"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.js"></script><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script>var pjax=new Pjax({selectors:["head title","main.content","#toc"],cache:!0,cacheBust:!1});function LoadTwikoo(){$.getScript("https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js",function(){initData={el:"#tcomment",envId:"twikoo-0gj90npu625abad8",region:"ap-shanghai",path:"window.location.pathname"};twikoo.init(initData)})}function LoadShare(){var e={sites:"facebook,qq,weibo,wechat,twitter".split(","),wechatQrcodeTitle:"WeChat scan: Share",wechatQrcodeHelper:"Download and send exclusive QR code now, and invite friends to join"};socialShare(".social-share",e)}function LoadFancybox(){$(".post-content img").each(function(){var e=document.createElement("a");$(e).attr("data-fancybox","images"),$(e).attr("href",$(this).attr("src")),$(this).wrap(e)}),$().fancybox({selector:'[data-fancybox="images"]',loop:!0,transitionEffect:"slide",protect:!0,buttons:["slideShow","fullScreen","thumbs","close"],hash:!1})}LoadTwikoo(),document.addEventListener("pjax:send",function(){var t=10;$("body").append("<div class='progress'></div>");clearInterval(timer),timer=setInterval(function(){var e=parseInt(7*Math.random());t+=e+3,$("body .progress").css("width",t+"%"),95<t&&(t=95)},500)}),LoadShare(),LoadFancybox();var timer=null;document.addEventListener("pjax:complete",function(){LoadTwikoo(),clearInterval(timer),$("body .progress").css("width","100%"),timer=setTimeout(function(){$("body .progress").remove()},700),$("#mobileNav").css("opacity","0"),$("#mobileNav").removeClass("open"),$("#mask").removeClass("mask"),$("#local-search").css("display","none"),$("html").css("overflow","auto"),LoadShare(),LoadFancybox(),document.querySelectorAll("script[data-pjax]").forEach(e=>{const t=document.createElement("script");var a=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(a)),e.parentNode.replaceChild(t,e)})})</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>