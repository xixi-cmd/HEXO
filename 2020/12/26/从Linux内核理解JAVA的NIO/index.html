<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="content-language" content="zh-CN"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><title>ä»Linuxå†…æ ¸ç†è§£JAVAçš„NIO | å¾®å®¢</title><link rel="icon" href="https://cn.chen-shang.top/img/favicon.png"><meta name="keywords" content="linux,JAVA,JVM"><meta name="description" content="å‰è¨€IO å¯ä»¥ç®€å•åˆ†ä¸ºç£ç›˜ IO å’Œ ç½‘ç»œ IO ,ç£ç›˜ IO ç›¸å¯¹äºç½‘ç»œ IO é€Ÿåº¦ä¼šå¿«ä¸€ç‚¹ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç» ç£ç›˜ IO ï¼Œç½‘ç»œ IO ä¸‹å‘¨å†™ã€‚
JAVA å¯¹  NIO æŠ½è±¡ä¸º Channel , C"><meta property="site_name" content="å¾®å®¢"><meta property="og:type" content="website"><meta property="og:url" content="http://example.com/2020/12/26/ä»Linuxå†…æ ¸ç†è§£JAVAçš„NIO/"><meta property="og:title" content="ä»Linuxå†…æ ¸ç†è§£JAVAçš„NIO | å¾®å®¢"><meta property="og:site_name" content="å¾®å®¢"><meta property="og:description" content="å‰è¨€IO å¯ä»¥ç®€å•åˆ†ä¸ºç£ç›˜ IO å’Œ ç½‘ç»œ IO ,ç£ç›˜ IO ç›¸å¯¹äºç½‘ç»œ IO é€Ÿåº¦ä¼šå¿«ä¸€ç‚¹ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç» ç£ç›˜ IO ï¼Œç½‘ç»œ IO ä¸‹å‘¨å†™ã€‚
JAVA å¯¹  NIO æŠ½è±¡ä¸º Channel , C"><meta property="og:locale" content="zh-CN"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="ä»Linuxå†…æ ¸ç†è§£JAVAçš„NIO | å¾®å®¢"><meta name="twitter:description" content="å‰è¨€IO å¯ä»¥ç®€å•åˆ†ä¸ºç£ç›˜ IO å’Œ ç½‘ç»œ IO ,ç£ç›˜ IO ç›¸å¯¹äºç½‘ç»œ IO é€Ÿåº¦ä¼šå¿«ä¸€ç‚¹ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç» ç£ç›˜ IO ï¼Œç½‘ç»œ IO ä¸‹å‘¨å†™ã€‚
JAVA å¯¹  NIO æŠ½è±¡ä¸º Channel , C"><link rel="dns-prefetch" href="http://example.com/2020/12/26/ä»Linuxå†…æ ¸ç†è§£JAVAçš„NIO/"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/StaticFile_HEXO@latest/butterfly/css/font-awesome-animation.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/StaticFile_HEXO@latest/butterfly/css/macWhite.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/xixi-cmd/JSD-/iconfont.css"><meta name="generator" content="Hexo 5.3.0"></head><body id="body"><div id="mask"></div><script type="text/javascript">$.getScript("/js/search.js",function(){searchFunc("/search.xml","local-search-input","local-search-result")})</script><div class="search-dialog" id="local-search"><div id="local-search-title">Local Search</div><input id="local-search-input" placeholder="Search the article" type="text"><hr><div id="local-search-result"><div id="local-hits"></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?8e216044fbe6b71b6fefc197c2508ed1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div style="display:flex"><div id="body-wrap"><nav class="site_nav" id="site_nav"><i id="openNav" class="fas fa-bars"></i> <i class="fas fa-search search-btn"></i><div id="mobileNav"><div class="author-info"><div><a href="/"><img src="https://thirdqq.qlogo.cn/g?b=sdk&amp;nk=3225454747&amp;s=140" alt="WeiKe_Joe" class="avatar"><div class="author">WeiKe_Joe</div></a></div><hr></div><ul><li><a href="/">èµ·å§‹é¡µğŸ¡</a></li><li><a href="/archives">å½’æ¡£ğŸ“•</a></li><li><a href="/tags">æ ‡ç­¾ğŸ—¿</a></li><li><a href="/categories">åˆ†ç±»ğŸ–¤</a></li><li><a href="/atom.xml">rssğŸ”—</a></li><li><a href="/link">å‹æƒ…é“¾æ¥ğŸ¤</a></li><li><a target="_blank" rel="noopener" href="https://user.qzone.qq.com/3225454747/main">QQç©ºé—´ğŸ§</a></li><li><a target="_blank" rel="noopener" href="https://travellings.now.sh">å¼€å¾€ğŸš€</a></li><li><a href="/liuyanban">ç•™è¨€æ¿ğŸ“¡</a></li></ul></div><ul><li><a href="/">èµ·å§‹é¡µğŸ¡</a></li><li><a href="/archives">å½’æ¡£ğŸ“•</a></li><li><a href="/tags">æ ‡ç­¾ğŸ—¿</a></li><li><a href="/categories">åˆ†ç±»ğŸ–¤</a></li><li><a href="/atom.xml">rssğŸ”—</a></li><li><a href="/link">å‹æƒ…é“¾æ¥ğŸ¤</a></li><li><a target="_blank" rel="noopener" href="https://user.qzone.qq.com/3225454747/main">QQç©ºé—´ğŸ§</a></li><li><a target="_blank" rel="noopener" href="https://travellings.now.sh">å¼€å¾€ğŸš€</a></li><li><a href="/liuyanban">ç•™è¨€æ¿ğŸ“¡</a></li></ul></nav><header><div class="card-content"><div class="author-info"><div><a href="/"><img src="https://thirdqq.qlogo.cn/g?b=sdk&amp;nk=3225454747&amp;s=140" alt="WeiKe_Joe" class="avatar"><div class="author">WeiKe_Joe</div></a></div></div><div id="description" class="description"><p>åœ¨äº’è”ç½‘è§’è½é‡ŒæŒ£æ‰çš„åšå®¢</p><div class="social-icon"><a target="_blank" rel="noopener" href="https://github.com/xixi-cmd"><i class="fab fa-github"></i></a> <a href="mailto:3225454747@qq.com"><i class="fas fa-envelope"></i></a> <a target="_blank" rel="noopener" href="https://space.bilibili.com/580303442"><i class="fab iconfont icon-bilibili-fill"></i></a> <a target="_blank" rel="noopener" href="https://music.163.com/#/user/home?id=3267730015"><i class="fab iconfont icon-wangyiyunyinyuemusic1193417easyiconnet"></i></a> <a target="_blank" rel="noopener" href="https://gusit.gitee.io/"><i class="fab iconfont icon-gitee-fill-round"></i></a> <a target="_blank" rel="noopener" href="https://www.cnblogs.com/UserZuoChen/"><i class="fab iconfont icon-bokeyuan"></i></a> <a target="_blank" rel="noopener" href="https://www.jianshu.com/u/ae6d65633faa"><i class="fab iconfont icon-jianshu"></i></a> <a target="_blank" rel="noopener" href="https://twitter.com/shelby86443093"><i class="fab fa-twitter"></i></a></div></div></div></header><main class="content"><article class="post"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><div class="post-title"><h2 class="title">ä»Linuxå†…æ ¸ç†è§£JAVAçš„NIO</h2></div><div class="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i> <span class="post-meta-label">Created 2020-12-26 | </span><i class="fas fa-history fa-fw post-meta-icon"></i> <span class="post-meta-label">Updated 2021-02-04</span></span></div><div class="meta-secondline"><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i> <span class="post-meta-label">Word Count:</span> <span class="word-count">3.9k | </span><i class="far fa-clock fa-fw post-meta-icon"></i> <span class="post-meta-label">Reading time:</span> <span>15min | </span><i class="far fa-eye fa-fw post-meta-icon"></i> <span id="/2020/12/26/%E4%BB%8ELinux%E5%86%85%E6%A0%B8%E7%90%86%E8%A7%A3JAVA%E7%9A%84NIO/" class="leancloud_visitors"><span class="post-meta-label">Visitors:</span> <span class="leancloud-visitors-count" id="twikoo_visitors">0</span></span></span></div></div><div class="post-content"><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>IO å¯ä»¥ç®€å•åˆ†ä¸º<code>ç£ç›˜ IO</code> å’Œ <code>ç½‘ç»œ IO</code> ,<code>ç£ç›˜ IO</code> ç›¸å¯¹äº<code>ç½‘ç»œ IO</code> é€Ÿåº¦ä¼šå¿«ä¸€ç‚¹ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç» <code>ç£ç›˜ IO</code> ï¼Œ<code>ç½‘ç»œ IO</code> ä¸‹å‘¨å†™ã€‚</p><p>JAVA å¯¹ <code>NIO</code> æŠ½è±¡ä¸º <code>Channel</code> , <code>Channel</code> åˆå¯ä»¥åˆ†ä¸º <code>FileChannel</code> ï¼ˆç£ç›˜ ioï¼‰å’Œ <code>SocketChannel</code> ï¼ˆç½‘ç»œ ioï¼‰ã€‚</p><p>å¦‚æœä½ å¯¹ IO çš„ç†è§£åªæ˜¯åœç•™åœ¨ api å±‚é¢é‚£æ˜¯è¿œè¿œä¸å¤Ÿçš„ï¼Œä¸€å®šè¦äº†è§£ IO åœ¨ç³»ç»Ÿå±‚é¢æ˜¯æ€ä¹ˆå¤„ç†çš„ã€‚</p><p>æœ¬æ–‡å†…å®¹ï¼š</p><li>FileChannel è¯»å†™å¤åˆ¶æ–‡ä»¶çš„ç”¨æ³•ã€‚</li><li>ByteBuffer çš„ä»‹ç»</li><li>jvm æ–‡ä»¶è¿›ç¨‹é”ï¼ŒFileLock</li><li>HeapByteBuffer ï¼ŒDirectByteBuffer å’Œ mmap è°çš„é€Ÿåº¦æ›´å¿«</li><li>ä» <code>Linux å†…æ ¸</code> ä¸­çš„ <code>è™šæ‹Ÿå†…å­˜</code> ã€<code>ç³»ç»Ÿè°ƒç”¨</code>ã€<code>æ–‡ä»¶æè¿°ç¬¦</code>ã€<code>Inode</code>ã€<code>Page Cache</code> ã€<code>ç¼ºé¡µå¼‚å¸¸</code>è®²è¿°æ•´ä¸ª IO çš„è¿‡ç¨‹</li><li>jvm å †å¤–çš„ DirectByteBuffer çš„å†…å­˜æ€ä¹ˆå›æ”¶</li><p><img src="https://upimage.alexhchu.com/2021/01/25/a27c9234cfee1.png" alt="image-20200711165857889"></p><blockquote><p>æœ¬æ–‡è®¡ç®—æœºç³»ç»Ÿç›¸å…³çš„å›¾å…¨éƒ¨æ¥è‡ª ã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿã€‹</p></blockquote><p>å¯¹ Linux çš„äº†è§£éƒ½æ˜¯æ¥è‡ªä¹¦ä¸Šå’ŒæŸ¥é˜…èµ„æ–™ï¼Œæœ¬æ–‡å†…å®¹ä¸»è¦æ˜¯æˆ‘è‡ªå·±çš„ç†è§£å’Œä»£ç éªŒè¯ï¼Œæœ‰çš„æè¿°ä¸ä¸€å®šå‡†ç¡®ï¼Œé‡åœ¨ç†è§£è¿‡ç¨‹å³å¯ã€‚</p><h1 id="NIO"><a href="#NIO" class="headerlink" title="NIO"></a>NIO</h1><p><code>NIO</code> æ˜¯ ä» Java 1.4 å¼€å§‹å¼•å…¥çš„ï¼Œè¢«ç§°ä¹‹ä¸º Non Blocking IOï¼Œä¹Ÿæœ‰ç§°ä¹‹ä¸º New IOã€‚</p><p>NIO æŠ½è±¡ä¸º <code>Channel</code> æ˜¯é¢å‘ç¼“å†²åŒºçš„ï¼ˆæ“ä½œçš„æ˜¯ä¸€å—æ•°æ®ï¼‰ï¼Œéé˜»å¡ IOã€‚</p><p><code>Channel</code> åªè´Ÿè´£ä¼ è¾“ï¼Œæ•°æ®ç”± <code>Buffer</code> è´Ÿè´£å­˜å‚¨ã€‚</p><p><code>NIO</code> æ˜¯ ä» Java 1.4 å¼€å§‹å¼•å…¥çš„ï¼Œè¢«ç§°ä¹‹ä¸º Non Blocking IOï¼Œä¹Ÿæœ‰ç§°ä¹‹ä¸º New IOã€‚</p><p>NIO æŠ½è±¡ä¸º <code>Channel</code> æ˜¯é¢å‘ç¼“å†²åŒºçš„ï¼ˆæ“ä½œçš„æ˜¯ä¸€å—æ•°æ®ï¼‰ï¼Œéé˜»å¡ IOã€‚</p><p><code>Channel</code> åªè´Ÿè´£ä¼ è¾“ï¼Œæ•°æ®ç”± <code>Buffer</code> è´Ÿè´£å­˜å‚¨ã€‚</p><h2 id="Buffer"><a href="#Buffer" class="headerlink" title="Buffer"></a>Buffer</h2><p><code>Buffer</code> ä¸­çš„ <code>capacity</code>ã€<code>limit</code> å’Œ <code>position</code> å±æ€§æ˜¯æ¯”è¾ƒé‡è¦çš„ï¼Œè¿™äº›å¼„ä¸æ˜ç™½ï¼Œè¯»å†™æ–‡ä»¶ä¼šé‡åˆ°å¾ˆå¤šå‘ã€‚</p><p><code>capacity</code> æ ‡è¯† <code>Buffer</code> æœ€å¤§æ•°æ®å®¹é‡ï¼Œç›¸ç­‰äºä¸€ä¸ªæ•°ç»„çš„é•¿åº¦ã€‚</p><p><code>limit</code> ä¸ºä¸€ä¸ªæŒ‡é’ˆï¼Œæ ‡è¯†å½“å‰æ•°ç»„å¯æ“ä½œçš„æ•°æ®çš„æœ€å¤§ç´¢å¼•ã€‚</p><p><code>position</code> è¡¨ç¤ºä¸ºä¸‹ä¸€ä¸ªè¯»å–æ•°æ®æ—¶çš„ç´¢å¼•</p><p><img src="https://upimage.alexhchu.com/2020/11/20/369ca8961b3b5.png" alt="images-20200711202515"></p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run1</span><span class="params">()</span> </span>&#123; </span><br><span class="line">  <span class="comment">// `DirectByteBuffer` </span></span><br><span class="line">  <span class="keyword">final</span> ByteBuffer byteBuffer = ByteBuffer.allocateDirect(<span class="number">1024</span>);</span><br><span class="line">   <span class="comment">// `HeapByteBuffer` </span></span><br><span class="line">  <span class="keyword">final</span> ByteBuffer allocate = ByteBuffer.allocate(<span class="number">1024</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><code>HeapByteBuffer</code> ä¼šåˆ†é…åœ¨ <code>Jvmå †å†…</code>ï¼Œå— JVM å †å¤§å°çš„é™åˆ¶ï¼Œåˆ›å»ºé€Ÿåº¦å¿«ï¼Œä½†æ˜¯è¯»å†™é€Ÿåº¦æ…¢ã€‚å®é™…åº•å±‚æ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„ã€‚</p><p><code>DirectByteBuffer</code> ä¼šåˆ†é… <code>Jvm å †å¤–</code>ï¼Œä¸å— JVM å †å¤§å°çš„é™åˆ¶ï¼Œåˆ›å»ºé€Ÿåº¦æ…¢ï¼Œè¯»å†™å¿«ã€‚<code>DirectByteBuffer</code> å†…å­˜åœ¨ Linux ä¸­ï¼Œå±äºè¿›ç¨‹çš„å †å†…ã€‚<code>DirectByteBuffer</code> å— jvm å‚æ•° <code>MaxDirectMemorySize</code> çš„å½±å“ã€‚</p><p>è®¾ç½® jvm å † 100mï¼Œè¿è¡Œç¨‹åºæŠ¥é”™ <code>Exception in thread "main" java.lang.OutOfMemoryError: Java heap space</code>ã€‚å› ä¸ºæŒ‡å®šäº† jvm å †ä¸º 100mï¼Œç„¶åä¸€äº› class æ–‡ä»¶ä¹Ÿä¼šæ”¾åœ¨ å †ä¸­çš„ï¼Œå®é™…å †å†…å­˜æ—¶ä¸è¶³ 100m,å½“ç”³è¯· 100m å †å†…å­˜åªèƒ½æŠ¥é”™äº†ã€‚</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BufferNio</span> </span>&#123; </span><br><span class="line">  <span class="comment">// -Xmx100m </span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123; </span><br><span class="line">    <span class="comment">// HeapByteBuffer æ˜¯ jvm å †å†…ï¼Œå› ä¸ºå †ä¸è¶³åˆ†é… 100m(java ä¸­çš„ä¸€äº› class ä¹Ÿä¼šå ç”¨å †)ï¼Œå¯¼è‡´ oom </span></span><br><span class="line">    System.out.println(<span class="string">&quot;ç”³è¯· 100 m `HeapByteBuffer`&quot;</span>); </span><br><span class="line">    Thread.sleep(<span class="number">5000</span>); </span><br><span class="line">    ByteBuffer.allocate(<span class="number">100</span> * <span class="number">1024</span> * <span class="number">1024</span>); </span><br><span class="line">  &#125;; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><p>è®¾ç½® jvm å †ä¸º 100mï¼ŒMaxDirectMemorySize ä¸º 1gï¼Œæ­»å¾ªç¯åˆ›å»º <code>DirectByteBuffer</code>ï¼Œæ‰“å° 10 æ¬¡ <code>ç”³è¯· directbuffer æˆåŠŸ</code>ï¼ŒæŠ¥é”™ <code>Exception in thread "main" java.lang.OutOfMemoryError: Direct buffer memory</code>ï¼Œåé¢å†è¯´è¿™ä¸ªå †å¤–çš„ <code>DirectByteBuffer</code> æ€ä¹ˆè¿›è¡Œå›æ”¶ã€‚</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BufferNio</span> </span>&#123; </span><br><span class="line">  <span class="comment">// -Xmx100m -XX:MaxDirectMemorySize=1g </span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123; </span><br><span class="line">    System.out.println(<span class="string">&quot;ç”³è¯· 100 m DirectByteBuffer&quot;</span>); </span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;Object&gt; objects = <span class="keyword">new</span> ArrayList&lt;&gt;(); </span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123; </span><br><span class="line">      <span class="comment">// DirectByteBuffer ä¸åœ¨ jvm å †å†…ï¼Œæ‰€ä»¥å¯ä»¥ç”³è¯·æˆåŠŸï¼Œä½†æ˜¯ä¸æ˜¯æ— é™åˆ¶çš„ï¼Œä¹Ÿæœ‰é™åˆ¶ï¼ˆMaxDirectMemorySizeï¼‰ </span></span><br><span class="line">      <span class="keyword">final</span> ByteBuffer byteBuffer = ByteBuffer.allocateDirect(<span class="number">100</span> * <span class="number">1024</span> * <span class="number">1024</span>); objects.add(byteBuffer); System.out.println(<span class="string">&quot;ç”³è¯· directbuffer æˆåŠŸ&quot;</span>); </span><br><span class="line"></span><br><span class="line">System.out.println(ManagementFactory.getMemoryMXBean().getHeapMemoryUsage()); </span><br><span class="line">System.out.println(ManagementFactory.getMemoryMXBean().getNonHeapMemoryUsage()); </span><br><span class="line">    &#125;; </span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><h2 id="FileChannel"><a href="#FileChannel" class="headerlink" title="FileChannel"></a>FileChannel</h2><h2 id="è¯»æ–‡ä»¶"><a href="#è¯»æ–‡ä»¶" class="headerlink" title="è¯»æ–‡ä»¶"></a>è¯»æ–‡ä»¶</h2><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123; <span class="keyword">final</span> Path path = Paths.get(FILE_NAME); </span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ª FileChannel,æŒ‡å®šè¿™ä¸ª channel è¯»å†™çš„æƒé™ </span></span><br><span class="line">  <span class="keyword">final</span> FileChannel open = FileChannel.open(path, StandardOpenOption.READ); </span><br><span class="line">  <span class="comment">// åˆ›å»ºä¸€ä¸ªå’Œè¿™ä¸ªæ–‡ä»¶å¤§å°ä¸€æ ·çš„ bufferï¼Œå°æ–‡ä»¶å¯ä»¥è¿™æ ·ï¼Œå¤§æ–‡ä»¶ï¼Œå¾ªç¯è¯» </span></span><br><span class="line">  <span class="keyword">final</span> ByteBuffer allocate = ByteBuffer.allocate((<span class="keyword">int</span>) open.size()); open.read(allocate); open.close(); </span><br><span class="line">  <span class="comment">// åˆ‡æ¢ä¸ºè¯»æ¨¡å¼ï¼Œposition=0 </span></span><br><span class="line">  allocate.flip(); </span><br><span class="line">  <span class="comment">// ç”¨ UTF-8 è§£ç  </span></span><br><span class="line">  <span class="keyword">final</span> CharBuffer decode = StandardCharsets.UTF_8.decode(allocate); </span><br><span class="line">  System.out.println(decode.toString()); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h2 id="å†™æ–‡ä»¶"><a href="#å†™æ–‡ä»¶" class="headerlink" title="å†™æ–‡ä»¶"></a>å†™æ–‡ä»¶</h2><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// é€šé“å…·æœ‰å†™æƒé™ï¼Œcreate æ ‡è¯†æ–‡ä»¶ä¸å­˜åœ¨çš„æ—¶å€™åˆ›å»º </span></span><br><span class="line">  <span class="keyword">final</span> FileChannel open = FileChannel.open(path, StandardOpenOption.WRITE, StandardOpenOption.CREATE); </span><br><span class="line">  <span class="keyword">final</span> ByteBuffer allocate = ByteBuffer.allocate(<span class="number">1024</span>); </span><br><span class="line">  allocate.put(<span class="string">&quot;ChenShang aaaaa-1111111&quot;</span>.getBytes(StandardCharsets.UTF_8)); </span><br><span class="line">  <span class="comment">// åˆ‡æ¢å†™æ¨¡å¼ï¼Œposition=0 </span></span><br><span class="line">  allocate.flip(); </span><br><span class="line">  open.write(allocate); </span><br><span class="line">  open.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h2 id="CVå¤§æ³•ï¼"><a href="#CVå¤§æ³•ï¼" class="headerlink" title="CVå¤§æ³•ï¼"></a>CVå¤§æ³•ï¼</h2><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">copy</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123; </span><br><span class="line">  <span class="keyword">final</span> Path srcPath = Paths.get(FILE_NAME); <span class="keyword">final</span> Path destPath = Paths.get(<span class="string">&quot;demo&quot;</span> + FILE_NAME); </span><br><span class="line">  <span class="keyword">final</span> FileChannel srcChannel = FileChannel.open(srcPath, StandardOpenOption.READ); </span><br><span class="line">  <span class="keyword">final</span> FileChannel destChannel = FileChannel.open(destPath, StandardOpenOption.WRITE, StandardOpenOption.CREATE); </span><br><span class="line">  <span class="comment">// transferTo å®ç°ç±»ä¸­ï¼Œç”¨çš„æ˜¯ä¸€ä¸ª 8M MappedByteBuffer åšæ•°æ®çš„ copy ,ä½†æ˜¯è¿™ä¸ªæ–¹æ³•åªèƒ½ copy æ–‡ä»¶æœ€å¤§å­—èŠ‚æ•°ä¸º Integer.MAX </span></span><br><span class="line">  srcChannel.transferTo(<span class="number">0</span>, srcChannel.size(), destChannel); </span><br><span class="line">  destChannel.close(); </span><br><span class="line">  srcChannel.close(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h2 id="FileLock"><a href="#FileLock" class="headerlink" title="FileLock"></a>FileLock</h2><p><code>FileLcok</code> æ˜¯ jvm è¿›ç¨‹æ–‡ä»¶é”ï¼Œåœ¨å¤šä¸ª jvm è¿›ç¨‹é—´ç”Ÿæ•ˆï¼Œè¿›ç¨‹äº«æœ‰æ–‡ä»¶çš„è¯»å†™æƒé™ï¼Œæœ‰å…±äº«é” å’Œ ç‹¬å é”ã€‚</p><p>åŒä¸€ä¸ªè¿›ç¨‹ä¸èƒ½é”åŒä¸€ä¸ªæ–‡ä»¶çš„é‡å¤åŒºåŸŸï¼Œä¸é‡å¤æ˜¯å¯ä»¥é”çš„ã€‚</p><p>åŒä¸€ä¸ªè¿›ç¨‹ä¸­ç¬¬ä¸€ä¸ªçº¿ç¨‹é”æ–‡ä»¶çš„ ï¼ˆ0ï¼Œ2ï¼‰ï¼ŒåŒæ—¶å¦ä¸€ä¸ªçº¿ç¨‹é”ï¼ˆ1ï¼Œ2ï¼‰ï¼Œæ–‡ä»¶é”çš„åŒºåŸŸæœ‰é‡å¤ï¼Œç¨‹åºä¼šæŠ¥é”™ã€‚</p><p>ä¸€ä¸ªè¿›ç¨‹é”ï¼ˆ0ï¼Œ2ï¼‰ï¼Œå¦ä¸€ä¸ªè¿›ç¨‹é”ï¼ˆ1ï¼Œ2ï¼‰è¿™æ˜¯å¯ä»¥çš„ï¼Œå› ä¸º <code>FileLock</code> æ˜¯ JVM è¿›ç¨‹é”ã€‚</p><p>è¿è¡Œä¸‹é¢ç¨‹åºä¸¤æ¬¡ï¼Œæ‰“å°ç»“æœä¸º</p><p>ç¬¬ä¸€ä¸ªç¨‹åºé¡ºåˆ©æ‰“å°</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Text"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è·å–åˆ°é”0-3,ä»£ç æ²¡æœ‰è¢«é˜»å¡</span><br><span class="line">è·å–åˆ°é”4-7,ä»£ç æ²¡æœ‰è¢«é˜»å¡</span><br></pre></td></tr></table></figure></div><p>ç¬¬äºŒä¸ªç¨‹åºæ‰“å°</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Code"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è·å–åˆ°é”4-7,ä»£ç æ²¡æœ‰è¢«é˜»å¡</span><br><span class="line">è·å–åˆ°é”0-3,ä»£ç æ²¡æœ‰è¢«é˜»å¡</span><br></pre></td></tr></table></figure></div><p>ç¬¬ä¸€ä¸ªç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼Œ<code>file_lock.txt</code> çš„ 0-2 ä½ç½®è¢«é”ä½äº†ï¼Œç¬¬ä¸€ä¸ªç¨‹åºæŒæœ‰é” 10 s,ç¬¬äºŒä¸ªç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼Œä¼šåœ¨è¿™é‡Œé˜»å¡ç­‰å¾… <code>FileLock</code>ï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªç¨‹åºé‡Šæ”¾äº†é”ã€‚</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileLock</span> </span>&#123; </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123; </span><br><span class="line">    <span class="keyword">final</span> Path path = Paths.get(<span class="string">&quot;file_lock.txt&quot;</span>); </span><br><span class="line">    <span class="keyword">final</span> FileChannel open = FileChannel.open(path, StandardOpenOption.WRITE, StandardOpenOption.READ); </span><br><span class="line">    <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">2</span>); <span class="keyword">new</span> Thread(() -&gt; &#123; </span><br><span class="line">      <span class="keyword">try</span> (<span class="keyword">final</span> java.nio.channels.FileLock lock = open.lock(<span class="number">0</span>, <span class="number">3</span>, <span class="keyword">false</span>)) &#123; </span><br><span class="line">        System.out.println(<span class="string">&quot;è·å–åˆ°é”0-3,ä»£ç æ²¡æœ‰è¢«é˜»å¡&quot;</span>); </span><br><span class="line">        Thread.sleep(<span class="number">10000</span>); <span class="keyword">final</span> ByteBuffer wrap = ByteBuffer.wrap(<span class="string">&quot;aaa&quot;</span>.getBytes()); </span><br><span class="line">        open.position(<span class="number">0</span>); open.write(wrap); Thread.sleep(<span class="number">10000</span>); &#125; <span class="keyword">catch</span> (IOException | InterruptedException e) &#123; </span><br><span class="line">          e.printStackTrace(); &#125; <span class="keyword">finally</span> &#123; countDownLatch.countDown(); </span><br><span class="line">          &#125; &#125;);</span><br><span class="line">          .start(); </span><br><span class="line">          Thread.sleep(<span class="number">1000</span>); </span><br><span class="line">          <span class="keyword">new</span> Thread(() -&gt; &#123; </span><br><span class="line">            <span class="keyword">try</span> (<span class="keyword">final</span> java.nio.channels.FileLock lock = open.lock(<span class="number">4</span>, <span class="number">3</span>, <span class="keyword">false</span>)) &#123; </span><br><span class="line">              System.out.println(<span class="string">&quot;è·å–åˆ°é”4-7,ä»£ç æ²¡æœ‰è¢«é˜»å¡&quot;</span>); </span><br><span class="line">              <span class="keyword">final</span> ByteBuffer wrap = ByteBuffer.wrap(<span class="string">&quot;bbb&quot;</span>.getBytes()); </span><br><span class="line">              open.position(<span class="number">4</span>); open.write(wrap); </span><br><span class="line">              &#125; </span><br><span class="line">              <span class="keyword">catch</span> (IOException e) &#123; </span><br><span class="line">                e.printStackTrace(); </span><br><span class="line">              &#125; </span><br><span class="line">                <span class="keyword">finally</span> &#123; countDownLatch.countDown(); </span><br><span class="line">            &#125;;</span><br><span class="line">          &#125;);</span><br><span class="line">          .start(); </span><br><span class="line">          countDownLatch.await(); </span><br><span class="line">          open.close(); </span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><p>å½“å°†ä¸Šé¢çš„ç¨‹åºç¬¬äºŒä¸ªçº¿ç¨‹æ”¹ä¸º <code>java.nio.channels.FileLock lock = open.lock(1, 3, false)</code> ï¼Œå› ä¸ºåŒä¸€ä¸ªè¿›ç¨‹ä¸å…è®¸é”æ–‡ä»¶çš„é‡å¤åŒºåŸŸï¼Œç¨‹åºä¼šæŠ¥é”™ã€‚</p><p><code>Exception in thread "Thread-1" java.nio.channels.OverlappingFileLockException</code></p><h2 id="HeapByteBuffer-å’Œ-DirectByteBuffer-è°çš„è¯»å†™æ•ˆç‡é«˜ï¼Ÿ"><a href="#HeapByteBuffer-å’Œ-DirectByteBuffer-è°çš„è¯»å†™æ•ˆç‡é«˜ï¼Ÿ" class="headerlink" title="HeapByteBuffer å’Œ DirectByteBuffer è°çš„è¯»å†™æ•ˆç‡é«˜ï¼Ÿ"></a>HeapByteBuffer å’Œ DirectByteBuffer è°çš„è¯»å†™æ•ˆç‡é«˜ï¼Ÿ</h2><p><code>FileChannel</code> çš„å®ç°ç±» <code>FileChannelImpl</code>ï¼Œå½“è¯»å†™ <code>ByteBuffer</code> ä¼šåˆ¤æ–­æ˜¯å¦æ˜¯ <code>DirectBuffer</code>ï¼Œä¸æ˜¯çš„è¯ï¼Œä¼šåˆ›å»ºä¸€ä¸ª <code>DirectBuffer</code>ï¼Œå°†åŸæ¥çš„çš„ Buffer æ•°æ® copy åˆ° <code>DirectBuffer</code> ä¸­ä½¿ç”¨ã€‚æ‰€ä»¥è¯»å†™æ•ˆç‡ä¸Šæ¥è¯´ï¼ŒDirectByteBuffer è¯»å†™æ›´å¿«ã€‚ä½†æ˜¯ <code>DirectByteBuffer</code> åˆ›å»ºç›¸å¯¹æ¥è¯´è€—æ—¶ã€‚</p><p>å°½ç®¡ <code>DirectByteBuffer</code> æ˜¯å †å¤–ï¼Œä½†æ˜¯å½“å †å¤–å†…å­˜å ç”¨è¾¾åˆ° <code>-XX:MaxDirectMemorySize</code> çš„æ—¶å€™ï¼Œä¹Ÿä¼šè§¦å‘ FullGC ï¼Œå¦‚æœå †å¤–æ²¡æœ‰åŠæ³•å›æ”¶å†…å­˜ï¼Œå°±ä¼šæŠ›å‡º OOMã€‚</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸‹é¢è¿™ä¸ªç¨‹åºä¼šä¸€ç›´æ‰§è¡Œä¸‹å»ï¼Œä½†æ˜¯ä¼šè§¦å‘ FullGCï¼Œæ¥å›æ”¶æ‰å †å¤–çš„ç›´æ¥å†…å­˜ </span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BufferNio</span> </span>&#123; </span><br><span class="line">  <span class="comment">// -Xmx100m -XX:MaxDirectMemorySize=1g </span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123; </span><br><span class="line">    System.out.println(<span class="string">&quot;ç”³è¯· 100 m `HeapByteBuffer`&quot;</span>); </span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123; </span><br><span class="line">      <span class="comment">// å½“å‰å¯¹è±¡æ²¡æœ‰è¢«å¼•ç”¨ï¼ŒGC root ä¹Ÿå°±åˆ°è¾¾ä¸äº† DirectByteBuffer </span></span><br><span class="line">      ByteBuffer.allocateDirect(<span class="number">100</span> * <span class="number">1024</span> * <span class="number">1024</span>); </span><br><span class="line">      System.out.println(<span class="string">&quot;ç”³è¯· directbuffer æˆåŠŸ&quot;</span>); </span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><p>æ­»å¾ªç¯åˆ›å»ºçš„ <code>DirectByteBuffer</code> æ²¡æœ‰ GC ROOT åˆ°è¾¾ï¼Œå¯¹è±¡ä¼šè¢«å›æ”¶æ‰ï¼Œå›æ”¶æ‰çš„æ—¶å€™ï¼Œä¹Ÿåªæ˜¯å›æ”¶æ‰å †å†…å•Šï¼Œå †å¤–çš„å›æ”¶æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿ</p><p>ä» <code>DirectByteBuffer</code> æºç ç€æ‰‹ï¼Œå¯ä»¥çœ‹åˆ°å®ƒæœ‰ä¸€ä¸ªæˆå‘˜å˜é‡ <code>private final Cleaner cleaner;</code>ï¼Œå½“è§¦å‘ FullGC çš„æ—¶å€™ï¼Œå› ä¸º <code>cleaner</code> æ²¡æœ‰ gc root å¯è¾¾ï¼Œå¯¼è‡´ <code>cleaner</code> ä¼šè¢«å›æ”¶ï¼Œå›æ”¶çš„æ—¶å€™ä¼šè§¦å‘ <code>Cleaner.clean</code></p><p>åœ¨Reference.tryHandlePending è§¦å‘ æ–¹æ³•çš„è°ƒç”¨ï¼Œthunk å°±æ˜¯ <code>DirectByteBuffer.Deallocator</code> çš„ç¤ºä¾‹ï¼Œè¿™ä¸ª run æ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº† <code>Unsafe.freeMemory</code> æ¥é‡Šæ”¾æ‰äº†å †å¤–å†…å­˜.</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cleaner</span> <span class="keyword">extends</span> <span class="title">PhantomReference</span>&lt;<span class="title">Object</span>&gt; </span>&#123; </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Runnable thunk; <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clean</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    <span class="keyword">if</span> (remove(<span class="keyword">this</span>)) &#123; <span class="keyword">try</span> &#123; <span class="keyword">this</span>.thunk.run(); </span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable var2) &#123; AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Void&gt;() &#123; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123; </span><br><span class="line">  <span class="keyword">if</span> (System.err != <span class="keyword">null</span>) &#123; (<span class="keyword">new</span> Error(<span class="string">&quot;Cleaner terminated abnormally&quot;</span>, var2)).printStackTrace(); &#125; System.exit(<span class="number">1</span>); <span class="keyword">return</span> <span class="keyword">null</span>; </span><br><span class="line">          &#125; </span><br><span class="line">        &#125;); </span><br><span class="line">      &#125; </span><br><span class="line">    &#125; </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h1 id="å†…å­˜æ˜ å°„"><a href="#å†…å­˜æ˜ å°„" class="headerlink" title="å†…å­˜æ˜ å°„"></a>å†…å­˜æ˜ å°„</h1><p><img src="/images/20200712125658.png" alt="images - 20200712125658.png"></p><p>å½“åº”ç”¨ç¨‹åºè¯»æ–‡ä»¶çš„æ—¶å€™ï¼Œæ•°æ®éœ€è¦ä»å…ˆä»ç£ç›˜è¯»å–åˆ°å†…æ ¸ç©ºé—´ç¬¬ä¸€æ¬¡è¯»å†™ï¼Œæ²¡æœ‰pagecacheç¼“å­˜æ•°æ®ï¼Œåœ¨ä»å†…æ ¸ç©ºé—´ copy åˆ°ç”¨æˆ·ç©ºé—´ï¼Œè¿™æ ·åº”ç”¨ç¨‹åºæ‰èƒ½ä½¿ç”¨è¯»åˆ°çš„æ•°æ®ã€‚å½“ä¸€ä¸ªæ–‡ä»¶çš„å…¨éƒ¨æ•°æ®éƒ½åœ¨å†…æ ¸çš„ Page Cache ä¸Šæ—¶ï¼Œå°±ä¸ç”¨å†ä»ç£ç›˜è¯»äº†ï¼Œç›´æ¥ä»å†…æ ¸ç©ºé—´ copy åˆ°ç”¨æˆ·ç©ºé—´å»äº†ã€‚</p><p>åº”ç”¨ç¨‹åºå¯¹ä¸€ä¸ªæ–‡ä»¶å†™æ•°æ®æ—¶ï¼Œå…ˆå°†è¦å†™çš„æ•°æ® copy åˆ°å†…æ ¸ çš„ page cacheï¼Œç„¶åè°ƒç”¨ fsync å°†æ•°æ®ä»å†…æ ¸è½ç›˜åˆ°æ–‡ä»¶ä¸Šï¼ˆåªè¦è°ƒç”¨è¿”å›æˆåŠŸï¼Œæ•°æ®å°±ä¸ä¼šä¸¢å¤±ï¼‰ã€‚æˆ–è€…ä¸è°ƒç”¨ fsync è½ç›˜ï¼Œåº”ç”¨ç¨‹åºçš„æ•°æ®åªè¦å†™å…¥åˆ° å†…æ ¸çš„ pagecache ä¸Šï¼Œå†™å…¥æ“ä½œå°±ç®—å®Œæˆäº†ï¼Œæ•°æ®çš„è½ç›˜äº¤ç”± å†…æ ¸ çš„ Io è°ƒåº¦ç¨‹åºåœ¨é€‚å½“çš„æ—¶æœºæ¥è½ç›˜ï¼ˆçªç„¶æ–­ç”µä¼šä¸¢æ•°æ®ï¼ŒMySQL è¿™æ ·çš„ç¨‹åºéƒ½æ˜¯è‡ªå·±ç»´æŠ¤æ•°æ®çš„è½ç›˜çš„ï¼‰ã€‚</p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•°æ®çš„è¯»å†™æ€»ä¼šç»è¿‡ä»ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çš„ copy ,å¦‚æœèƒ½æŠŠè¿™ä¸ª copy å»æ‰ï¼Œæ•ˆç‡å°±ä¼šé«˜å¾ˆå¤šï¼Œè¿™å°±æ˜¯ mmap ï¼ˆå†…å­˜æ˜ å°„ï¼‰ã€‚å°†ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„å†…å­˜æŒ‡å‘åŒä¸€å—ç‰©ç†å†…å­˜ã€‚<code>å†…å­˜æ˜ å°„</code> è‹±æ–‡ä¸º <code>Memory Mapping</code> ,ç¼©å†™ <code>mmap</code>ã€‚å¯¹åº”ç³»ç»Ÿè°ƒç”¨ <a href="https://man7.org/linux/man-pages/man2/mmap.2.html" target="_blank" rel="noopener" one-link-mark="yes" style="color:Green;text-decoration:/">mmap</a></p><p>è¿™æ ·åœ¨ç”¨æˆ·ç©ºé—´è¯»å†™æ•°æ®ï¼Œå®é™…æ“ä½œçš„ä¹Ÿæ˜¯å†…æ ¸ç©ºé—´çš„ï¼Œå‡å°‘äº†æ•°æ®çš„ copy ã€‚</p><p><img src="/images/20200712145306.png" alt="images - 20200712145306.png"></p><p>æ€ä¹ˆå®ç°çš„å‘¢ï¼Œç®€å•æ¥è¯´å°±æ˜¯ linux ä¸­è¿›ç¨‹çš„åœ°å€æ˜¯è™šæ‹Ÿåœ°å€ï¼Œcpu ä¼šå°†è™šæ‹Ÿåœ°å€æ˜ å°„åˆ°ç‰©ç†å†…å­˜çš„ç‰©ç†åœ°å€ä¸Šã€‚mmap å®é™…æ˜¯å°†ç”¨æˆ·è¿›ç¨‹çš„æŸå—è™šæ‹Ÿåœ°å€ä¸å†…æ ¸ç©ºé—´çš„æŸå—è™šæ‹Ÿåœ°å€æ˜ å°„åˆ°åŒä¸€å—ç‰©ç†å†…å­˜ä¸Šï¼Œå·²è¾¾åˆ°å‡å°‘æ•°æ®çš„ copy ã€‚</p><p>ç”¨æˆ·ç¨‹åºè°ƒç”¨ç³»ç»Ÿè°ƒç”¨ <code>mmap</code> ä¹‹åçš„æ•°æ®çš„è¯»å†™éƒ½ä¸éœ€è¦è°ƒç”¨ç³»ç»Ÿè°ƒç”¨ <code>read</code> å’Œ <code>write</code> äº†ã€‚</p><h2 id="è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜çš„æ˜ å°„"><a href="#è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜çš„æ˜ å°„" class="headerlink" title="è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜çš„æ˜ å°„"></a>è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜çš„æ˜ å°„</h2><p>è®¡ç®—æœºçš„ä¸»å­˜å¯ä»¥çœ‹åšæ˜¯ç”± M ä¸ªè¿ç»­å­—èŠ‚ç»„æˆçš„æ•°ç»„ï¼Œæ¯ä¸ªå­—èŠ‚éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€<code>ç‰©ç†åœ°å€</code> (<code>Physical Address</code>)ã€‚</p><p>Cpu ä½¿ç”¨çš„ <code>è™šæ‹Ÿå¯»å€</code> ï¼ˆ<code>VA</code>,<code>Virtual Address</code>ï¼‰ æ¥æŸ¥æ‰¾ç‰©ç†åœ°å€ã€‚</p><p><img src="/images/20200711171400.png" alt="images - 20200711171400.png"></p><p><code>CPU</code> ä¼šå°†è¿›ç¨‹ä½¿ç”¨çš„ <code>è™šæ‹Ÿåœ°å€</code> é€šè¿‡ CPU ä¸Šçš„ç¡¬ä»¶ <code>å†…å­˜ç®¡ç†å•å…ƒ</code> (<code>Memory Management Unit</code> <code>MMU</code>) çš„è¿›è¡Œåœ°å€ç¿»è¯‘æ‰¾åˆ°ç‰©ç†ä¸»å­˜ä¸­çš„ç‰©ç†åœ°å€ï¼Œä»è€Œè·å–æ•°æ®ã€‚</p><p>å½“è¿›ç¨‹åŠ è½½ä¹‹åï¼Œç³»ç»Ÿä¼šä¸ºè¿›ç¨‹åˆ†é…ä¸€ä¸ª<code>è™šæ‹Ÿåœ°å€ç©ºé—´</code>ï¼Œå½“è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„æŸä¸ª <code>è™šæ‹Ÿåœ°å€</code> è¢«ä½¿ç”¨çš„æ—¶å€™ï¼Œå°±ä¼šå°†å…¶å…ˆæ˜ å°„åˆ°ä¸»å­˜ä¸Šçš„ <code>ç‰©ç†åœ°å€</code>ã€‚</p><p>å½“å¤šä¸ªè¿›ç¨‹éœ€è¦å…±äº«æ•°æ®çš„æ—¶å€™ï¼Œåªéœ€è¦å°†å…¶è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„æŸäº›è™šæ‹Ÿåœ°å€æ˜ å°„ç›¸åŒçš„ç‰©ç†åœ°å€å³å¯ã€‚</p><p>é€šå¸¸æˆ‘ä»¬æ“ä½œæ•°æ®çš„æ—¶å€™ï¼Œä¸ä¼šä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚çš„æ“ä½œï¼Œè¿™æ ·æ•ˆç‡å¤ªä½ï¼Œé€šå¸¸éƒ½æ˜¯è¿ç»­è®¿é—®æŸäº›å­—èŠ‚ã€‚æ‰€ä»¥åœ¨å†…å­˜ç®¡ç†çš„æ—¶å€™ï¼Œå°†å†…å­˜ç©ºé—´åˆ†å‰²ä¸ºé¡µæ¥ç®¡ç†ï¼Œç‰©ç†å†…å­˜ä¸­æœ‰<code>ç‰©ç†é¡µ</code>ï¼ˆ<code>Physical Page</code>ï¼‰ï¼Œè™šæ‹Ÿå†…å­˜ä¸­æœ‰ <code>Virtual Page</code> æ¥ç®¡ç†ã€‚é€šå¸¸é¡µçš„å¤§å°ä¸º 4KBã€‚</p><p>ç³»ç»Ÿé€šè¿‡ MMU å’Œ <code>é¡µè¡¨ï¼ˆPage Tableï¼‰</code> æ¥ç®¡ç† <code>è™šæ‹Ÿé¡µ</code> å’Œ <code>ç‰©ç†ä¹Ÿ</code> çš„å¯¹åº”å…³ç³»ï¼Œé¡µè¡¨å°±æ˜¯é¡µè¡¨æ¡ç›®ï¼ˆ<code>Page Table Entry,PTE</code>ï¼‰çš„æ•°ç»„</p><p><img src="/images/20200711183510.png" alt="images - 20200711183510.png"></p><p>PTE çš„æœ‰æ•ˆä¸º1æ—¶ï¼Œæ ‡è¯†æ•°æ®åœ¨å†…å­˜ä¸­ï¼Œæ ‡è¯†ä¸º 0 æ—¶ï¼Œæ ‡è¯†åœ¨ç£ç›˜ä¸Šã€‚</p><p>å½“è®¿é—®çš„è™šæ‹Ÿåœ°å€å¯¹åº”çš„æ•°æ®ä¸å†ç‰©ç†å†…å­˜ä¸Šæ—¶ï¼Œä¼šæœ‰ä¸¤ç§æƒ…å†µå¤„ç†ï¼š</p><p>1ã€åœ¨å†…å­˜å¤Ÿç”¨çš„æ—¶å€™ï¼Œä¼šç›´æ¥å°†è™šæ‹Ÿé¡µå¯¹åº”åœ¨ç£ç›˜ä¸Šçš„æ•°æ®åŠ è½½åˆ°ç‰©ç†å†…å­˜ä¸Šï¼Œ</p><p>2ã€å½“å†…å­˜ä¸å¤Ÿç”¨çš„æ—¶å€™ï¼Œå°±ä¼šè§¦å‘ swap,ä¼šæ ¹æ® LRU å°†æœ€è¿‘ä½¿ç”¨é¢‘ç‡æ¯”è¾ƒä½çš„è™šæ‹Ÿé¡µå¯¹åº”ç‰©ç†ä¹Ÿæ·˜æ±°æ‰ï¼Œå†™å…¥åˆ°ç£ç›˜ä¸­å»ï¼Œæ·˜æ±°æ‰ä¸€éƒ¨åˆ†ç‰©ç†å†…å­˜ä¸­çš„æ•°æ®ï¼Œç„¶åå¯¹å¯¹åº”çš„è™šæ‹Ÿé¡µè®¾ç½®ä¸º 0ï¼Œç„¶åå°†ç£ç›˜ä¸Šçš„æ•°æ®å†åŠ è½½åˆ°å†…å­˜ä¸­å»ã€‚</p><h2 id="è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜"><a href="#è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜" class="headerlink" title="è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜"></a>è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜</h2><p><code>Linux</code> ä¼šä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…ä¸€ä¸ªå•ç‹¬çš„è™šæ‹Ÿå†…å­˜åœ°å€ï¼Œ</p><p><img src="/images/20200711174755.png" alt="images - 20200711174755.png"></p><p>å½“æˆ‘ä»¬çš„ç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼Œä¸æ˜¯æ•´ä¸ªç¨‹åºçš„ä»£ç æ–‡ä»¶ä¸€æ¬¡æ€§å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­å»ï¼Œè€Œæ˜¯æ‰§è¡Œæ‡’åŠ è½½ã€‚</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Text"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">æœºæ¢°ç¡¬ç›˜ä½¿ç”¨æ‰‡åŒºæ¥ç®¡ç†ç£ç›˜ï¼Œç£ç›˜æ§åˆ¶å™¨ä¼šé€šè¿‡å—ç®¡ç†ç£ç›˜ï¼Œç³»ç»Ÿé€šè¿‡ Page Cache ä¸ç£ç›˜æ§åˆ¶å™¨æ‰“äº¤é“ã€‚ </span><br><span class="line">ä¸€ä¸ªå—åŒ…å«å¤šä¸ªæ‰‡åŒºï¼Œä¸€ä¸ªé¡µä¹ŸåŒ…å«å¤šä¸ªå—ã€‚ ç£ç›˜ä¸Šä¼šæœ‰ä¸€ä¸ªæ–‡ä»¶å¯¹åº”ä¸€ä¸ª Inodeï¼ŒInnode è®°å½•æ–‡ä»¶çš„å…ƒæ•°æ®åŠæ•°æ®æ‰€åœ¨ä½ç½®ã€‚ </span><br><span class="line">å½“ç³»ç»Ÿå¯åŠ¨çš„æ—¶å€™ï¼Œè¿™äº› Inode æ•°æ®ä¼šè¢«åŠ è½½åˆ°ä¸»å­˜ä¸­å»ã€‚ä¸è¿‡ç³»ç»Ÿä¸­çš„ Inode è¿˜è®°å½•ä»–ä»¬å¯¹åº”çš„ç‰©ç†å†…å­˜ä¸­çš„ä½ç½®ï¼ˆå®é™…å°±æ˜¯å¯¹åº” Page Cacheï¼‰</span><br><span class="line">ï¼Œæœ‰çš„ Inode å¯¹åº”çš„æ•°æ®æ²¡æœ‰åŠ è½½åˆ°å†…å­˜ä¸­ï¼ŒInode å°±ä¸ä¼šè®°å½•å…¶å¯¹åº”çš„å†…å­˜åœ°å€ã€‚ </span><br><span class="line">ç¨‹åºæ‰§è¡Œä¹‹å‰ä¼šåˆå§‹åŒ–å…¶è™šæ‹Ÿå†…å­˜ï¼Œè™šæ‹Ÿå†…å­˜ä¼šè®°å½•ä»£ç å¯¹åº”å“ªäº› Innodeã€‚</span><br></pre></td></tr></table></figure></div><p>å½“æ‰§è¡Œç¨‹åºçš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šåˆå§‹åŒ–å½“å‰ç¨‹åºçš„è™šæ‹Ÿå†…å­˜ï¼Œç„¶åè¿è¡Œ <code>main</code> å‡½æ•°ï¼Œå½“å‘ç°æ‰§è¡Œä»£ç æ—¶ï¼Œæœ‰çš„ä»£ç æ²¡æœ‰åŠ è½½åˆ°å†…å­˜ï¼Œå°±ä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œå°†æ ¹æ®è™šæ‹Ÿé¡µæ‰¾åˆ°å¯¹åº”çš„ <code>Innoe</code> ï¼Œç„¶åå°†ç£ç›˜ä¸­éœ€è¦çš„æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œç„¶åå°†è™šæ‹Ÿé¡µæ ‡è®°ä¸ºå·²åŠ è½½åˆ°å†…å­˜ï¼Œä¸‹æ¬¡è®¿é—®ç›´æ¥ä»å†…å­˜ä¸­è®¿é—®ã€‚</p><h1 id="Java-ä¸­çš„-mmap"><a href="#Java-ä¸­çš„-mmap" class="headerlink" title="Java ä¸­çš„ mmap"></a>Java ä¸­çš„ mmap</h1><p>çœ‹æºç æˆ‘ä»¬å‘ç° <code>open.map</code> è¿”å›çš„ä¹Ÿæ˜¯ <code>DirectByteBuffer</code>ï¼Œåªæ˜¯è¿™ä¸ªæ–¹æ³•è¿”å›çš„ <code>DirectByteBuffer</code> ä½¿ç”¨äº†ä¸åŒçš„æ„é€ æ–¹æ³•ï¼Œå®ƒç»‘å®šäº†ä¸€ä¸ª <code>fd</code> ã€‚å½“æˆ‘ä»¬è¯»å†™æ•°æ®çš„æ—¶å€™æ˜¯ä¸ä¼šè§¦å‘ç³»ç»Ÿè°ƒç”¨ read å’Œ write çš„ï¼Œä¹Ÿå°±æ˜¯å†…å­˜æ˜ å°„çš„å¥½å¤„ã€‚</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MMapDemo</span> </span>&#123; <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> URISyntaxException, IOException,InterruptedException  </span>&#123; </span><br><span class="line">    <span class="keyword">final</span> URL resource = MMapDemo.class.getClassLoader().getResource(<span class="string">&quot;demo.txt&quot;</span>); </span><br><span class="line">    <span class="keyword">final</span> Path path = Paths.get(resource.toURI()); <span class="keyword">final</span> FileChannel open = FileChannel.open(path, StandardOpenOption.READ); </span><br><span class="line">    <span class="comment">// å‘èµ·ç³»ç»Ÿè°ƒç”¨ mmap </span></span><br><span class="line">    <span class="keyword">final</span> MappedByteBuffer map = open.map(FileChannel.MapMode.READ_ONLY, <span class="number">0</span>, </span><br><span class="line">    open.size()); </span><br><span class="line">    <span class="comment">// è¯»å–æ•°æ®æ—¶ï¼Œä¸ä¼šå†å‡ºå‘è°ƒç”¨ read,ç›´æ¥ä»è‡ªå·±çš„è™šæ‹Ÿå†…å­˜ä¸­å³å¯æ‹¿æ•°æ® </span></span><br><span class="line">    <span class="keyword">final</span> CharBuffer decode = StandardCharsets.UTF_8.decode(map); </span><br><span class="line">    System.out.println(decode.toString()); </span><br><span class="line">    open.close(); </span><br><span class="line">    Thread.sleep(<span class="number">100000</span>); </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>å°½ç®¡ä¸‹é¢è¿™ä¸ªä¹Ÿæ˜¯ <code>DirectByteBuffer</code> ï¼Œä½†æ˜¯å®ƒå’Œ mmap ä¸åŒçš„æ˜¯ï¼Œä»–æ²¡æœ‰ç»‘å®š fdï¼Œè¯»å†™æ•°æ®çš„æ—¶å€™è¿˜æ˜¯è¦ç»è¿‡ä»ç”¨æˆ·ç©ºé—´åˆ°å†…æ ¸ç©ºé—´çš„ copy ,ä¹Ÿä¼šå‘ç”Ÿç³»ç»Ÿè°ƒç”¨ï¼Œæ•ˆç‡ç›¸å¯¹ mmap ä½ã€‚</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Java"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MMapDemo</span> </span>&#123; </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> URISyntaxException, IOException, InterruptedException </span>&#123; </span><br><span class="line">    <span class="keyword">final</span> URL resource = MMapDemo.class.getClassLoader().getResource(<span class="string">&quot;demo.txt&quot;</span>); </span><br><span class="line">    <span class="keyword">final</span> Path path = Paths.get(resource.toURI()); </span><br><span class="line">    <span class="keyword">final</span> FileChannel open = FileChannel.open(path, StandardOpenOption.READ); </span><br><span class="line">    <span class="comment">// è¿™ä¸ª DirectByteBuffer ä½¿ç”¨çš„æ„é€ ä¸ä¸€æ ·ï¼Œå®ƒä¼šèµ°ç³»ç»Ÿè°ƒç”¨ read </span></span><br><span class="line">    <span class="keyword">final</span> ByteBuffer byteBuffer = ByteBuffer.allocateDirect(<span class="number">1024</span>); </span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> read = open.read(byteBuffer); byteBuffer.flip(); </span><br><span class="line">    System.out.println(StandardCharsets.UTF_8.decode(byteBuffer).toString()); </span><br><span class="line">    Thread.sleep(<span class="number">100000</span>); </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>è¿½è¸ªä»£ç çš„ç³»ç»Ÿè°ƒç”¨ï¼Œåœ¨ linux ä¸‹ä½¿ç”¨ <code>strace</code></p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-rel="Bash"><span class="clipboard" data-clipboard-target=".code"><i class="fa fa-clipboard"></i></span><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">rm -fr /nio/out.*</span><br><span class="line"><span class="built_in">cd</span> /nio/target/classes</span><br><span class="line">strace -ff -o /nio/out java com.fly.blog.nio.MMapDemo</span><br></pre></td></tr></table></figure></div><p>æ•°æ®è¯»å†™é€Ÿåº¦ä¸Š <code>mmap</code> å¤§äº <code>ByteBuffer.allocateDirect</code> å¤§äº <code>ByteBuffer.allocate</code>ã€‚</p></div><div class="post-copyright"><div class="post-copyright-icon"><a></a></div><div class="post-copyright__author"><span class="post-copyright-meta">Authorship: </span><span class="post-copyright-info"><a href="mailto:3225454747@qq.com" one-link-mark="yes">WeiKe_Joe</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Article Links: </span><span class="post-copyright-info"><a href="http://example.com/2020/12/26/ä»Linuxå†…æ ¸ç†è§£JAVAçš„NIO/" one-link-mark="yes">http://example.com/2020/12/26/ä»Linuxå†…æ ¸ç†è§£JAVAçš„NIO/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright: </span><span class="post-copyright-info">All articles in this blog are used unless otherwise stated <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" one-link-mark="yes">CC BY-NC-SA 4.0</a> License Agreement. Reprint please indicate from <a href="http://example.com" target="_blank" one-link-mark="yes">å¾®å®¢</a> ï¼</span></div></div><div class="post-tag"><span><i class="fa fa-tag"></i> <a href="tags/linux/"><span>linux</span></a> <i class="fas fa-angle-right"></i> <a href="tags/JAVA/"><span>JAVA</span></a> <i class="fas fa-angle-right"></i> <a href="tags/JVM/"><span>JVM</span></a></span></div><div class="social-share"></div></article><style data-pjax>#body-wrap{margin:60px 0;margin-left:300px}@media screen and (max-width:1400px){#body-wrap{margin:60px 0;margin-left:150px}}@media screen and (max-width:1300px){#body-wrap{margin:60px 0;margin-left:60px}}@media screen and (max-width:1200px){#toc{margin:60px 10px 0}#body-wrap{margin:60px 0 0 2%}}@media screen and (max-width:1100px){.comment-head{padding:0 20px 0 20px}}@media screen and (max-width:1000px){#toc{display:none;height:250px;position:fixed;right:35px;bottom:30px;top:48%;z-index:1000;width:280px;background:rgba(255,255,255,.9);margin:0}.toc{max-height:180px!important}#body-wrap{margin:60px auto}.rightside-toc{display:inline-block!important}}@media screen and (max-width:800px){.comment-head{padding:0 20px 30px 20px}}@media screen and (max-width:600px){.social-share{text-align:center;float:none;margin:0}}</style><script>setInterval(function(){document.body.clientWidth<800&&$("img#up").remove()},0)</script><section id="rightside"><div id="rightside-item"><a class="rightside-toc" title="Catalog"><i class="fas fa-list-ul"></i> </a><a href="#Direct comments" title="Direct comments"><i class="fas fa-comments"></i> </a><a href="#body" title="Back To Top"><i class="fas fa-arrow-up"></i></a></div></section><div class="pagination"><a href="/2020/12/26/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" class="page-pre"><i class="fas fa-arrow-alt-circle-left"></i> å¦‚ä½•åé»‘å®¢åé—¨ç¨‹åº </a><a href="/2020/12/26/Python2/" class="page-next">Pythonä¸­çš„Pandas <i class="fas fa-arrow-alt-circle-right"></i></a></div><hr><section id="rightside"><div id="rightside-item"><a href="#Direct comments" title="Direct comments"><i class="fas fa-comments"></i> </a><a href="#body" title="Back To Top"><i class="fas fa-arrow-up"></i></a></div></section><div class="comment-head" id="Direct comments"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>Comments</span></div><div id="tcomment"></div></div></main></div><div id="toc"><div id="toc-title"><h4>Catalog <span id="num">0%</span></h4><progress id="progress" value="0" max="100"></progress></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">å‰è¨€</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#NIO"><span class="toc-text">NIO</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Buffer"><span class="toc-text">Buffer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FileChannel"><span class="toc-text">FileChannel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BB%E6%96%87%E4%BB%B6"><span class="toc-text">è¯»æ–‡ä»¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E6%96%87%E4%BB%B6"><span class="toc-text">å†™æ–‡ä»¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CV%E5%A4%A7%E6%B3%95%EF%BC%81"><span class="toc-text">CVå¤§æ³•ï¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FileLock"><span class="toc-text">FileLock</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HeapByteBuffer-%E5%92%8C-DirectByteBuffer-%E8%B0%81%E7%9A%84%E8%AF%BB%E5%86%99%E6%95%88%E7%8E%87%E9%AB%98%EF%BC%9F"><span class="toc-text">HeapByteBuffer å’Œ DirectByteBuffer è°çš„è¯»å†™æ•ˆç‡é«˜ï¼Ÿ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84"><span class="toc-text">å†…å­˜æ˜ å°„</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E4%B8%8E%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E7%9A%84%E6%98%A0%E5%B0%84"><span class="toc-text">è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜çš„æ˜ å°„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98"><span class="toc-text">è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Java-%E4%B8%AD%E7%9A%84-mmap"><span class="toc-text">Java ä¸­çš„ mmap</span></a></li></ol></div></div><img id="up" src="https://cdn.jsdelivr.net/gh/lete114/CDN/Use/up.gif" alt="rightside.å›åˆ°é¡¶éƒ¨"><footer class="footer" id="footer"><div class="copyright">&copy; 2020 - 2021 <i class="fas fa-heartbeat"></i> WeiKe_Joe</div><div class="framework-info"><span>Framework </span><a href="https://hexo.io" target="_blank">Hexo</a> <span class="footer-separator">|</span> <span>Theme </span><a href="https://github.com/lete114/hexo-theme-MengD" target="_blank">MengD.(èŒå…¸)</a></div><div class="custom-text">æˆ‘ä¸€ç›´åœ¨åæ€ï¼Œå¦‚æœæœªæ¥å·²å®šï¼Œé‚£ä¹ˆå¥‹æ–—çš„æ„ä¹‰ä½•åœ¨ï¼›å¦‚æœæœªæ¥ä¸å®šã€‚é‚£ä¹ˆå½“ä¸‹è¯¥å¦‚ä½•è¡ŒåŠ¨ï¼Ÿ</div></footer><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script src="/js/main.js"></script><script src="/js/style.js"></script><script src="/live2d-widget/autoload.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="https://api.vvhan.com/api/snow"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.js"></script><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script>var pjax=new Pjax({selectors:["head title","main.content","#toc"],cache:!0,cacheBust:!1});function LoadTwikoo(){$.getScript("https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js",function(){initData={el:"#tcomment",envId:"twikoo-0gj90npu625abad8",region:"ap-shanghai",path:"window.location.pathname"};twikoo.init(initData)})}function LoadShare(){var e={sites:"facebook,qq,weibo,wechat,twitter".split(","),wechatQrcodeTitle:"WeChat scan: Share",wechatQrcodeHelper:"Download and send exclusive QR code now, and invite friends to join"};socialShare(".social-share",e)}function LoadFancybox(){$(".post-content img").each(function(){var e=document.createElement("a");$(e).attr("data-fancybox","images"),$(e).attr("href",$(this).attr("src")),$(this).wrap(e)}),$().fancybox({selector:'[data-fancybox="images"]',loop:!0,transitionEffect:"slide",protect:!0,buttons:["slideShow","fullScreen","thumbs","close"],hash:!1})}LoadTwikoo(),document.addEventListener("pjax:send",function(){var t=10;$("body").append("<div class='progress'></div>");clearInterval(timer),timer=setInterval(function(){var e=parseInt(7*Math.random());t+=e+3,$("body .progress").css("width",t+"%"),95<t&&(t=95)},500)}),LoadShare(),LoadFancybox();var timer=null;document.addEventListener("pjax:complete",function(){LoadTwikoo(),clearInterval(timer),$("body .progress").css("width","100%"),timer=setTimeout(function(){$("body .progress").remove()},700),$("#mobileNav").css("opacity","0"),$("#mobileNav").removeClass("open"),$("#mask").removeClass("mask"),$("#local-search").css("display","none"),$("html").css("overflow","auto"),LoadShare(),LoadFancybox(),document.querySelectorAll("script[data-pjax]").forEach(e=>{const t=document.createElement("script");var a=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(a)),e.parentNode.replaceChild(t,e)})})</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>